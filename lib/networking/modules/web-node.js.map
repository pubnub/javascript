{"version":3,"sources":["networking/modules/web-node.js"],"names":["get","post","del","log","req","_pickLogger","console","window","start","Date","getTime","timestamp","toISOString","logger","url","qs","on","now","elapsed","timestampDone","res","text","xdr","superagentConstruct","endpoint","callback","_config","logVerbosity","use","proxy","_modules","call","keepAlive","timeout","end","err","resp","parsedResponse","status","error","operation","statusCode","response","errorData","JSON","parse","e","category","_detectErrorCategory","message","service","params","superagent","getStandardOrigin","query","body","send","delete"],"mappings":"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","file":"web-node.js","sourcesContent":["/* @flow */\r\n/* global window */\r\n\r\nimport superagent from 'superagent';\r\nimport {\r\n  EndpointDefinition,\r\n  StatusAnnouncement,\r\n} from '../../core/flow_interfaces';\r\n\r\nfunction log(req: Object) {\r\n  let _pickLogger = () => {\r\n    if (console && console.log) return console; // eslint-disable-line no-console\r\n    if (window && window.console && window.console.log) return window.console;\r\n    return console;\r\n  };\r\n\r\n  let start = new Date().getTime();\r\n  let timestamp = new Date().toISOString();\r\n  let logger = _pickLogger();\r\n  logger.log('<<<<<'); // eslint-disable-line no-console\r\n  logger.log(`[${timestamp}]`, '\\n', req.url, '\\n', req.qs); // eslint-disable-line no-console\r\n  logger.log('-----'); // eslint-disable-line no-console\r\n\r\n  req.on('response', res => {\r\n    let now = new Date().getTime();\r\n    let elapsed = now - start;\r\n    let timestampDone = new Date().toISOString();\r\n\r\n    logger.log('>>>>>>'); // eslint-disable-line no-console\r\n    logger.log(\r\n      `[${timestampDone} / ${elapsed}]`,\r\n      '\\n',\r\n      req.url,\r\n      '\\n',\r\n      req.qs,\r\n      '\\n',\r\n      res.text\r\n    ); // eslint-disable-line no-console\r\n    logger.log('-----'); // eslint-disable-line no-console\r\n  });\r\n}\r\n\r\nfunction xdr(\r\n  superagentConstruct: superagent,\r\n  endpoint: EndpointDefinition,\r\n  callback: Function\r\n): Object {\r\n  if (this._config.logVerbosity) {\r\n    superagentConstruct = superagentConstruct.use(log);\r\n  }\r\n\r\n  if (this._config.proxy && this._modules.proxy) {\r\n    superagentConstruct = this._modules.proxy.call(this, superagentConstruct);\r\n  }\r\n\r\n  if (this._config.keepAlive && this._modules.keepAlive) {\r\n    superagentConstruct = this._modules.keepAlive(superagentConstruct);\r\n  }\r\n\r\n  return superagentConstruct.timeout(endpoint.timeout).end((err, resp) => {\r\n    let parsedResponse;\r\n    let status: StatusAnnouncement = {};\r\n    status.error = err !== null;\r\n    status.operation = endpoint.operation;\r\n\r\n    if (resp && resp.status) {\r\n      status.statusCode = resp.status;\r\n    }\r\n\r\n    if (err) {\r\n      if (err.response && err.response.text && !this._config.logVerbosity) {\r\n        try {\r\n          status.errorData = JSON.parse(err.response.text);\r\n        } catch (e) {\r\n          status.errorData = err;\r\n        }\r\n      } else {\r\n        status.errorData = err;\r\n      }\r\n      status.category = this._detectErrorCategory(err);\r\n      return callback(status, null);\r\n    }\r\n\r\n    try {\r\n      parsedResponse = JSON.parse(resp.text);\r\n    } catch (e) {\r\n      status.errorData = resp;\r\n      status.error = true;\r\n      return callback(status, null);\r\n    }\r\n\r\n    if (\r\n      parsedResponse.error &&\r\n      parsedResponse.error === 1 &&\r\n      parsedResponse.status &&\r\n      parsedResponse.message &&\r\n      parsedResponse.service\r\n    ) {\r\n      status.errorData = parsedResponse;\r\n      status.statusCode = parsedResponse.status;\r\n      status.error = true;\r\n      status.category = this._detectErrorCategory(status);\r\n      return callback(status, null);\r\n    }\r\n\r\n    return callback(status, parsedResponse);\r\n  });\r\n}\r\n\r\nexport function get(\r\n  params: Object,\r\n  endpoint: EndpointDefinition,\r\n  callback: Function\r\n): superagent {\r\n  let superagentConstruct = superagent\r\n    .get(this.getStandardOrigin() + endpoint.url)\r\n    .query(params);\r\n  return xdr.call(this, superagentConstruct, endpoint, callback);\r\n}\r\n\r\nexport function post(\r\n  params: Object,\r\n  body: string,\r\n  endpoint: EndpointDefinition,\r\n  callback: Function\r\n): superagent {\r\n  let superagentConstruct = superagent\r\n    .post(this.getStandardOrigin() + endpoint.url)\r\n    .query(params)\r\n    .send(body);\r\n  return xdr.call(this, superagentConstruct, endpoint, callback);\r\n}\r\n\r\nexport function del(\r\n  params: Object,\r\n  endpoint: EndpointDefinition,\r\n  callback: Function\r\n): superagent {\r\n  let superagentConstruct = superagent\r\n    .delete(this.getStandardOrigin() + endpoint.url)\r\n    .query(params);\r\n  return xdr.call(this, superagentConstruct, endpoint, callback);\r\n}\r\n"]}