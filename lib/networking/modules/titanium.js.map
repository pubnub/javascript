{"version":3,"sources":["networking/modules/titanium.js"],"names":["get","post","log","url","qs","res","_pickLogger","Ti","API","window","console","start","Date","getTime","timestamp","toISOString","logger","now","elapsed","timestampDone","getHttpClient","Platform","osname","XMLHttpRequest","Network","createHTTPClient","keepAlive","xhr","_config","enableKeepAlive","encodedKeyValuePair","pairs","key","value","Array","isArray","forEach","item","Object","keys","subkey","push","encodeURIComponent","buildUrl","params","join","xdr","method","body","endpoint","callback","status","operation","open","call","onload","error","statusCode","resp","JSON","parse","responseText","logVerbosity","onerror","e","errorData","category","_detectErrorCategory","timeout","Infinity","send","getStandardOrigin"],"mappings":";;;;;;;;QA4GgBA,G,GAAAA,G;QAQAC,I,GAAAA,I;;AAjHhB;;AAIA,SAASC,GAAT,CAAaC,GAAb,EAAkBC,EAAlB,EAAsBC,GAAtB,EAA2B;AACzB,MAAIC,cAAc,SAAdA,WAAc,GAAM;AACtB,QAAIC,MAAMA,GAAGC,GAAT,IAAgBD,GAAGC,GAAH,CAAON,GAA3B,EAAgC,OAAOK,GAAGC,GAAV;AAChC,QAAIC,UAAUA,OAAOC,OAAjB,IAA4BD,OAAOC,OAAP,CAAeR,GAA/C,EAAoD,OAAOO,OAAOC,OAAd;AACpD,WAAOA,OAAP;AACD,GAJD;;AAMA,MAAIC,QAAQ,IAAIC,IAAJ,GAAWC,OAAX,EAAZ;AACA,MAAIC,YAAY,IAAIF,IAAJ,GAAWG,WAAX,EAAhB;AACA,MAAIC,SAASV,aAAb;AACAU,SAAOd,GAAP,CAAW,OAAX;AACAc,SAAOd,GAAP,OAAeY,SAAf,QAA6B,IAA7B,EAAmCX,GAAnC,EAAwC,IAAxC,EAA8CC,EAA9C;AACAY,SAAOd,GAAP,CAAW,OAAX;;AAEA,MAAIe,MAAM,IAAIL,IAAJ,GAAWC,OAAX,EAAV;AACA,MAAIK,UAAUD,MAAMN,KAApB;AACA,MAAIQ,gBAAgB,IAAIP,IAAJ,GAAWG,WAAX,EAApB;;AAEAC,SAAOd,GAAP,CAAW,QAAX;AACAc,SAAOd,GAAP,OAAeiB,aAAf,WAAkCD,OAAlC,QAA8C,IAA9C,EAAoDf,GAApD,EAAyD,IAAzD,EAA+DC,EAA/D,EAAmE,IAAnE,EAAyEC,GAAzE;AACAW,SAAOd,GAAP,CAAW,OAAX;AACD;;AAED,SAASkB,aAAT,GAA8B;AAC5B,MAAIb,GAAGc,QAAH,CAAYC,MAAZ,KAAuB,WAA3B,EAAwC;AACtC,WAAO,IAAIC,cAAJ,EAAP;AACD,GAFD,MAEO;AACL,WAAOhB,GAAGiB,OAAH,CAAWC,gBAAX,EAAP;AACD;AACF;;AAED,SAASC,SAAT,CAAmBC,GAAnB,EAAmC;AACjC,MAAIpB,GAAGc,QAAH,CAAYC,MAAZ,KAAuB,WAAvB,IAAsC,KAAKM,OAAL,CAAaF,SAAvD,EAAkE;AAChEC,QAAIE,eAAJ,GAAsB,IAAtB;AACD;AACF;;AAED,SAASC,mBAAT,CAA6BC,KAA7B,EAAoCC,GAApC,EAAiDC,KAAjD,EAAsE;AACpE,MAAIA,SAAS,IAAb,EAAmB;AACjB,QAAIC,MAAMC,OAAN,CAAcF,KAAd,CAAJ,EAA0B;AACxBA,YAAMG,OAAN,CAAc,UAACC,IAAD,EAAU;AACtBP,4BAAoBC,KAApB,EAA2BC,GAA3B,EAAgCK,IAAhC;AACD,OAFD;AAGD,KAJD,MAIO,IAAI,QAAOJ,KAAP,yCAAOA,KAAP,OAAiB,QAArB,EAA+B;AACpCK,aAAOC,IAAP,CAAYN,KAAZ,EAAmBG,OAAnB,CAA2B,UAACI,MAAD,EAAY;AACrCV,4BAAoBC,KAApB,EAA8BC,GAA9B,SAAqCQ,MAArC,QAAgDP,MAAMO,MAAN,CAAhD;AACD,OAFD;AAGD,KAJM,MAIA;AACLT,YAAMU,IAAN,CAAcC,mBAAmBV,GAAnB,CAAd,SAAyCU,mBAAmBT,KAAnB,CAAzC;AACD;AACF,GAZD,MAYO,IAAIA,UAAU,IAAd,EAAoB;AACzBF,UAAMU,IAAN,CAAWC,wBAAsBA,mBAAmBV,GAAnB,CAAtB,CAAX;AACD;AACF;;AAED,SAASW,QAAT,CAAkBxC,GAAlB,EAA+ByC,MAA/B,EAA+C;AAC7C,MAAIb,QAAQ,EAAZ;;AAEAO,SAAOC,IAAP,CAAYK,MAAZ,EAAoBR,OAApB,CAA4B,UAACJ,GAAD,EAAS;AACnCF,wBAAoBC,KAApB,EAA2BC,GAA3B,EAAgCY,OAAOZ,GAAP,CAAhC;AACD,GAFD;;AAIA,SAAU7B,GAAV,SAAiB4B,MAAMc,IAAN,CAAW,GAAX,CAAjB;AACD;;AAED,SAASC,GAAT,CAAanB,GAAb,EAAuBoB,MAAvB,EAAuC5C,GAAvC,EAAoDyC,MAApD,EAAoEI,IAApE,EAAkFC,QAAlF,EAAgHC,QAAhH,EAA0I;AAAA;;AACxI,MAAIC,SAA6B,EAAjC;AACAA,SAAOC,SAAP,GAAmBH,SAASG,SAA5B;;AAEAzB,MAAI0B,IAAJ,CAASN,MAAT,EAAiBJ,SAASxC,GAAT,EAAcyC,MAAd,CAAjB,EAAwC,IAAxC;;AAEAlB,YAAU4B,IAAV,CAAe,IAAf,EAAqB3B,GAArB;;AAEAA,MAAI4B,MAAJ,GAAa,YAAM;AACjBJ,WAAOK,KAAP,GAAe,KAAf;;AAEA,QAAI7B,IAAIwB,MAAR,EAAgB;AACdA,aAAOM,UAAP,GAAoB9B,IAAIwB,MAAxB;AACD;;AAED,QAAIO,OAAOC,KAAKC,KAAL,CAAWjC,IAAIkC,YAAf,CAAX;;AAEA,QAAI,MAAKjC,OAAL,CAAakC,YAAjB,EAA+B;AAC7B5D,UAAIC,GAAJ,EAASyC,MAAT,EAAiBjB,IAAIkC,YAArB;AACD;;AAED,WAAOX,SAASC,MAAT,EAAiBO,IAAjB,CAAP;AACD,GAdD;;AAgBA/B,MAAIoC,OAAJ,GAAc,UAACC,CAAD,EAAO;AACnBb,WAAOK,KAAP,GAAe,IAAf;AACAL,WAAOc,SAAP,GAAmBD,EAAER,KAArB;AACAL,WAAOe,QAAP,GAAkB,MAAKC,oBAAL,CAA0BH,EAAER,KAA5B,CAAlB;AACA,WAAON,SAASC,MAAT,EAAiB,IAAjB,CAAP;AACD,GALD;;AAOAxB,MAAIyC,OAAJ,GAAcC,QAAd;;AAEA1C,MAAI2C,IAAJ,CAAStB,IAAT;AACD;;AAEM,SAAShD,GAAT,CAAa4C,MAAb,EAA6BK,QAA7B,EAA2DC,QAA3D,EAA+E;AACpF,MAAIvB,MAAMP,eAAV;;AAEA,MAAIjB,MAAM,KAAKoE,iBAAL,KAA2BtB,SAAS9C,GAA9C;;AAEA,SAAO2C,IAAIQ,IAAJ,CAAS,IAAT,EAAe3B,GAAf,EAAoB,KAApB,EAA2BxB,GAA3B,EAAgCyC,MAAhC,EAAwC,EAAxC,EAA4CK,QAA5C,EAAsDC,QAAtD,CAAP;AACD;;AAEM,SAASjD,IAAT,CAAc2C,MAAd,EAA8BI,IAA9B,EAA4CC,QAA5C,EAA0EC,QAA1E,EAA8F;AACnG,MAAIvB,MAAMP,eAAV;;AAEA,MAAIjB,MAAM,KAAKoE,iBAAL,KAA2BtB,SAAS9C,GAA9C;;AAEA,SAAO2C,IAAIQ,IAAJ,CAAS,IAAT,EAAe3B,GAAf,EAAoB,MAApB,EAA4BxB,GAA5B,EAAiCyC,MAAjC,EAAyCe,KAAKC,KAAL,CAAWZ,IAAX,CAAzC,EAA2DC,QAA3D,EAAqEC,QAArE,CAAP;AACD","file":"titanium.js","sourcesContent":["/* @flow */\n/* global Ti, XMLHttpRequest, window, console */\n\nimport { EndpointDefinition, StatusAnnouncement } from '../../core/flow_interfaces';\n\ndeclare var Ti: any;\n\nfunction log(url, qs, res) {\n  let _pickLogger = () => {\n    if (Ti && Ti.API && Ti.API.log) return Ti.API; // eslint-disable-line no-console\n    if (window && window.console && window.console.log) return window.console;\n    return console;\n  };\n\n  let start = new Date().getTime();\n  let timestamp = new Date().toISOString();\n  let logger = _pickLogger();\n  logger.log('<<<<<');                                               // eslint-disable-line no-console\n  logger.log(`[${timestamp}]`, '\\n', url, '\\n', qs);    // eslint-disable-line no-console\n  logger.log('-----');                                               // eslint-disable-line no-console\n\n  let now = new Date().getTime();\n  let elapsed = now - start;\n  let timestampDone = new Date().toISOString();\n\n  logger.log('>>>>>>');                                                                                  // eslint-disable-line no-console\n  logger.log(`[${timestampDone} / ${elapsed}]`, '\\n', url, '\\n', qs, '\\n', res);  // eslint-disable-line no-console\n  logger.log('-----');\n}\n\nfunction getHttpClient(): any {\n  if (Ti.Platform.osname === 'mobileweb') {\n    return new XMLHttpRequest();\n  } else {\n    return Ti.Network.createHTTPClient();\n  }\n}\n\nfunction keepAlive(xhr: any): void {\n  if (Ti.Platform.osname !== 'mobileweb' && this._config.keepAlive) {\n    xhr.enableKeepAlive = true;\n  }\n}\n\nfunction encodedKeyValuePair(pairs, key: string, value: Object): void {\n  if (value != null) {\n    if (Array.isArray(value)) {\n      value.forEach((item) => {\n        encodedKeyValuePair(pairs, key, item);\n      });\n    } else if (typeof value === 'object') {\n      Object.keys(value).forEach((subkey) => {\n        encodedKeyValuePair(pairs, `${key}[${subkey}]`, value[subkey]);\n      });\n    } else {\n      pairs.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);\n    }\n  } else if (value === null) {\n    pairs.push(encodeURIComponent(`${encodeURIComponent(key)}`));\n  }\n}\n\nfunction buildUrl(url: string, params: Object) {\n  let pairs = [];\n\n  Object.keys(params).forEach((key) => {\n    encodedKeyValuePair(pairs, key, params[key]);\n  });\n\n  return `${url}?${pairs.join('&')}`;\n}\n\nfunction xdr(xhr: any, method: string, url: string, params: Object, body: Object, endpoint: EndpointDefinition, callback: Function): void {\n  let status: StatusAnnouncement = {};\n  status.operation = endpoint.operation;\n\n  xhr.open(method, buildUrl(url, params), true);\n\n  keepAlive.call(this, xhr);\n\n  xhr.onload = () => {\n    status.error = false;\n\n    if (xhr.status) {\n      status.statusCode = xhr.status;\n    }\n\n    let resp = JSON.parse(xhr.responseText);\n\n    if (this._config.logVerbosity) {\n      log(url, params, xhr.responseText);\n    }\n\n    return callback(status, resp);\n  };\n\n  xhr.onerror = (e) => {\n    status.error = true;\n    status.errorData = e.error;\n    status.category = this._detectErrorCategory(e.error);\n    return callback(status, null);\n  };\n\n  xhr.timeout = Infinity;\n\n  xhr.send(body);\n}\n\nexport function get(params: Object, endpoint: EndpointDefinition, callback: Function) {\n  let xhr = getHttpClient();\n\n  let url = this.getStandardOrigin() + endpoint.url;\n\n  return xdr.call(this, xhr, 'GET', url, params, {}, endpoint, callback);\n}\n\nexport function post(params: Object, body: string, endpoint: EndpointDefinition, callback: Function) {\n  let xhr = getHttpClient();\n\n  let url = this.getStandardOrigin() + endpoint.url;\n\n  return xdr.call(this, xhr, 'POST', url, params, JSON.parse(body), endpoint, callback);\n}\n"]}