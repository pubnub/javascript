{"version":3,"sources":["core/endpoints/subscribe.js"],"names":["getOperation","validateParams","getURL","getRequestTimeout","isAuthSupported","prepareParams","handleResponse","operationConstants","PNSubscribeOperation","modules","config","subscribeKey","incomingParams","channels","stringifiedChannels","length","join","utils","encodeString","getSubscribeTimeout","state","channelGroups","timetoken","filterExpression","region","params","heartbeat","getPresenceTimeout","Object","keys","JSON","stringify","tt","tr","serverResponse","messages","m","forEach","publishMetaData","publishTimetoken","rawMessage","p","t","r","parsedMessage","shard","parseInt","a","subscriptionMatch","b","channel","c","payload","d","flags","f","issuingClientId","i","k","originationTimetoken","o","userMetadata","u","push","metadata"],"mappings":";;;;;QAagBA,Y,GAAAA,Y;QAIAC,c,GAAAA,c;QAMAC,M,GAAAA,M;QAYAC,iB,GAAAA,iB;QAIAC,e,GAAAA,e;QAIAC,a,GAAAA,a;QAsCAC,c,GAAAA,c;;AA/EhB;;AAQA;;;;AACA;;;;;;AAEO,SAASN,YAAT,GAAgC;AACrC,SAAOO,qBAAmBC,oBAA1B;AACD;;AAEM,SAASP,cAAT,CAAwBQ,OAAxB,EAAgD;AAAA,MAC/CC,MAD+C,GACpCD,OADoC,CAC/CC,MAD+C;;;AAGrD,MAAI,CAACA,OAAOC,YAAZ,EAA0B,OAAO,uBAAP;AAC3B;;AAEM,SAAST,MAAT,CACLO,OADK,EAELG,cAFK,EAGG;AAAA,MACFF,MADE,GACSD,OADT,CACFC,MADE;AAAA,8BAEgBE,cAFhB,CAEFC,QAFE;AAAA,MAEFA,QAFE,yCAES,EAFT;;AAGR,MAAIC,sBAAsBD,SAASE,MAAT,GAAkB,CAAlB,GAAsBF,SAASG,IAAT,CAAc,GAAd,CAAtB,GAA2C,GAArE;AACA,4BAAwBN,OAAOC,YAA/B,SAA+CM,gBAAMC,YAAN,CAC7CJ,mBAD6C,CAA/C;AAGD;;AAEM,SAASX,iBAAT,OAAsD;AAAA,MAAzBO,MAAyB,QAAzBA,MAAyB;;AAC3D,SAAOA,OAAOS,mBAAP,EAAP;AACD;;AAEM,SAASf,eAAT,GAA2B;AAChC,SAAO,IAAP;AACD;;AAEM,SAASC,aAAT,QAELO,cAFK,EAGG;AAAA,MAFNF,MAEM,SAFNA,MAEM;AAAA,MAENU,KAFM,GAOJR,cAPI,CAENQ,KAFM;AAAA,+BAOJR,cAPI,CAGNS,aAHM;AAAA,MAGNA,aAHM,0CAGU,EAHV;AAAA,MAINC,SAJM,GAOJV,cAPI,CAINU,SAJM;AAAA,MAKNC,gBALM,GAOJX,cAPI,CAKNW,gBALM;AAAA,MAMNC,MANM,GAOJZ,cAPI,CAMNY,MANM;;AAQR,MAAMC,SAAiB;AACrBC,eAAWhB,OAAOiB,kBAAP;AADU,GAAvB;;AAIA,MAAIN,cAAcN,MAAd,GAAuB,CAA3B,EAA8B;AAC5BU,WAAO,eAAP,IAA0BJ,cAAcL,IAAd,CAAmB,GAAnB,CAA1B;AACD;;AAED,MAAIO,oBAAoBA,iBAAiBR,MAAjB,GAA0B,CAAlD,EAAqD;AACnDU,WAAO,aAAP,IAAwBF,gBAAxB;AACD;;AAED,MAAIK,OAAOC,IAAP,CAAYT,KAAZ,EAAmBL,MAAvB,EAA+B;AAC7BU,WAAOL,KAAP,GAAeU,KAAKC,SAAL,CAAeX,KAAf,CAAf;AACD;;AAED,MAAIE,SAAJ,EAAe;AACbG,WAAOO,EAAP,GAAYV,SAAZ;AACD;;AAED,MAAIE,MAAJ,EAAY;AACVC,WAAOQ,EAAP,GAAYT,MAAZ;AACD;;AAED,SAAOC,MAAP;AACD;;AAEM,SAASnB,cAAT,CACLG,OADK,EAELyB,cAFK,EAGc;AACnB,MAAMC,WAAoC,EAA1C;;AAEAD,iBAAeE,CAAf,CAAiBC,OAAjB,CAAyB,sBAAc;AACrC,QAAIC,kBAAmC;AACrCC,wBAAkBC,WAAWC,CAAX,CAAaC,CADM;AAErClB,cAAQgB,WAAWC,CAAX,CAAaE;AAFgB,KAAvC;AAIA,QAAIC,gBAAkC;AACpCC,aAAOC,SAASN,WAAWO,CAApB,EAAuB,EAAvB,CAD6B;AAEpCC,yBAAmBR,WAAWS,CAFM;AAGpCC,eAASV,WAAWW,CAHgB;AAIpCC,eAASZ,WAAWa,CAJgB;AAKpCC,aAAOd,WAAWe,CALkB;AAMpCC,uBAAiBhB,WAAWiB,CANQ;AAOpC9C,oBAAc6B,WAAWkB,CAPW;AAQpCC,4BAAsBnB,WAAWoB,CARG;AASpCC,oBAAcrB,WAAWsB,CATW;AAUpCxB;AAVoC,KAAtC;AAYAH,aAAS4B,IAAT,CAAcnB,aAAd;AACD,GAlBD;;AAoBA,MAAMoB,WAA8B;AAClC1C,eAAWY,eAAeQ,CAAf,CAAiBA,CADM;AAElClB,YAAQU,eAAeQ,CAAf,CAAiBC;AAFS,GAApC;;AAKA,SAAO,EAAER,kBAAF,EAAY6B,kBAAZ,EAAP;AACD","file":"subscribe.js","sourcesContent":["/* @flow */\r\n\r\nimport {\r\n  SubscribeArguments,\r\n  PublishMetaData,\r\n  SubscribeMetadata,\r\n  SubscribeMessage,\r\n  SubscribeEnvelope,\r\n  ModulesInject,\r\n} from '../flow_interfaces';\r\nimport operationConstants from '../constants/operations';\r\nimport utils from '../utils';\r\n\r\nexport function getOperation(): string {\r\n  return operationConstants.PNSubscribeOperation;\r\n}\r\n\r\nexport function validateParams(modules: ModulesInject) {\r\n  let { config } = modules;\r\n\r\n  if (!config.subscribeKey) return 'Missing Subscribe Key';\r\n}\r\n\r\nexport function getURL(\r\n  modules: ModulesInject,\r\n  incomingParams: SubscribeArguments\r\n): string {\r\n  let { config } = modules;\r\n  let { channels = [] } = incomingParams;\r\n  let stringifiedChannels = channels.length > 0 ? channels.join(',') : ',';\r\n  return `/v2/subscribe/${config.subscribeKey}/${utils.encodeString(\r\n    stringifiedChannels\r\n  )}/0`;\r\n}\r\n\r\nexport function getRequestTimeout({ config }: ModulesInject) {\r\n  return config.getSubscribeTimeout();\r\n}\r\n\r\nexport function isAuthSupported() {\r\n  return true;\r\n}\r\n\r\nexport function prepareParams(\r\n  { config }: ModulesInject,\r\n  incomingParams: SubscribeArguments\r\n): Object {\r\n  let {\r\n    state,\r\n    channelGroups = [],\r\n    timetoken,\r\n    filterExpression,\r\n    region,\r\n  } = incomingParams;\r\n  const params: Object = {\r\n    heartbeat: config.getPresenceTimeout(),\r\n  };\r\n\r\n  if (channelGroups.length > 0) {\r\n    params['channel-group'] = channelGroups.join(',');\r\n  }\r\n\r\n  if (filterExpression && filterExpression.length > 0) {\r\n    params['filter-expr'] = filterExpression;\r\n  }\r\n\r\n  if (Object.keys(state).length) {\r\n    params.state = JSON.stringify(state);\r\n  }\r\n\r\n  if (timetoken) {\r\n    params.tt = timetoken;\r\n  }\r\n\r\n  if (region) {\r\n    params.tr = region;\r\n  }\r\n\r\n  return params;\r\n}\r\n\r\nexport function handleResponse(\r\n  modules: ModulesInject,\r\n  serverResponse: Object\r\n): SubscribeEnvelope {\r\n  const messages: Array<SubscribeMessage> = [];\r\n\r\n  serverResponse.m.forEach(rawMessage => {\r\n    let publishMetaData: PublishMetaData = {\r\n      publishTimetoken: rawMessage.p.t,\r\n      region: rawMessage.p.r,\r\n    };\r\n    let parsedMessage: SubscribeMessage = {\r\n      shard: parseInt(rawMessage.a, 10),\r\n      subscriptionMatch: rawMessage.b,\r\n      channel: rawMessage.c,\r\n      payload: rawMessage.d,\r\n      flags: rawMessage.f,\r\n      issuingClientId: rawMessage.i,\r\n      subscribeKey: rawMessage.k,\r\n      originationTimetoken: rawMessage.o,\r\n      userMetadata: rawMessage.u,\r\n      publishMetaData,\r\n    };\r\n    messages.push(parsedMessage);\r\n  });\r\n\r\n  const metadata: SubscribeMetadata = {\r\n    timetoken: serverResponse.t.t,\r\n    region: serverResponse.t.r,\r\n  };\r\n\r\n  return { messages, metadata };\r\n}\r\n"]}