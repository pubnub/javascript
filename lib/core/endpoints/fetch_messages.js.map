{"version":3,"sources":["core/endpoints/fetch_messages.js"],"names":["getOperation","validateParams","getURL","getRequestTimeout","isAuthSupported","prepareParams","handleResponse","__processMessage","modules","message","config","crypto","cipherKey","decrypt","e","operationConstants","PNFetchMessagesOperation","incomingParams","channels","length","subscribeKey","stringifiedChannels","join","utils","encodeString","getTransactionTimeout","start","end","count","stringifiedTimeToken","outgoingParams","max","string_message_token","serverResponse","response","Object","keys","forEach","channelName","messageEnvelope","announce","channel","subscription","timetoken","push"],"mappings":"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","file":"fetch_messages.js","sourcesContent":["/* @flow */\r\n\r\nimport { FetchMessagesArguments, FetchMessagesResponse, MessageAnnouncement, HistoryV3Response, ModulesInject } from '../flow_interfaces';\r\nimport operationConstants from '../constants/operations';\r\nimport utils from '../utils';\r\n\r\nfunction __processMessage(modules, message: Object): Object | null {\r\n  let { config, crypto } = modules;\r\n  if (!config.cipherKey) return message;\r\n\r\n  try {\r\n    return crypto.decrypt(message);\r\n  } catch (e) {\r\n    return message;\r\n  }\r\n}\r\n\r\nexport function getOperation(): string {\r\n  return operationConstants.PNFetchMessagesOperation;\r\n}\r\n\r\nexport function validateParams(modules: ModulesInject, incomingParams: FetchMessagesArguments) {\r\n  let { channels } = incomingParams;\r\n  let { config } = modules;\r\n\r\n  if (!channels || channels.length === 0) return 'Missing channels';\r\n  if (!config.subscribeKey) return 'Missing Subscribe Key';\r\n}\r\n\r\nexport function getURL(modules: ModulesInject, incomingParams: FetchMessagesArguments): string {\r\n  let { channels = [] } = incomingParams;\r\n  let { config } = modules;\r\n\r\n  let stringifiedChannels = channels.length > 0 ? channels.join(',') : ',';\r\n  return `/v3/history/sub-key/${config.subscribeKey}/channel/${utils.encodeString(stringifiedChannels)}`;\r\n}\r\n\r\nexport function getRequestTimeout({ config }: ModulesInject): boolean {\r\n  return config.getTransactionTimeout();\r\n}\r\n\r\nexport function isAuthSupported(): boolean {\r\n  return true;\r\n}\r\n\r\nexport function prepareParams(modules: ModulesInject, incomingParams: FetchMessagesArguments): Object {\r\n  const { start, end, count, stringifiedTimeToken = false } = incomingParams;\r\n  let outgoingParams: Object = {};\r\n\r\n  if (count) outgoingParams.max = count;\r\n  if (start) outgoingParams.start = start;\r\n  if (end) outgoingParams.end = end;\r\n  if (stringifiedTimeToken) outgoingParams.string_message_token = 'true';\r\n\r\n  return outgoingParams;\r\n}\r\n\r\nexport function handleResponse(modules: ModulesInject, serverResponse: HistoryV3Response): FetchMessagesResponse {\r\n  const response: FetchMessagesResponse = {\r\n    channels: {}\r\n  };\r\n\r\n  Object.keys(serverResponse.channels || {}).forEach((channelName) => {\r\n    response.channels[channelName] = [];\r\n\r\n    (serverResponse.channels[channelName] || []).forEach((messageEnvelope) => {\r\n      let announce: MessageAnnouncement = {};\r\n      announce.channel = channelName;\r\n      announce.subscription = null;\r\n      announce.timetoken = messageEnvelope.timetoken;\r\n      announce.message = __processMessage(modules, messageEnvelope.message);\r\n      response.channels[channelName].push(announce);\r\n    });\r\n  });\r\n\r\n  return response;\r\n}\r\n"]}