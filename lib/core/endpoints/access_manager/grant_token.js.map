{"version":3,"sources":["core/endpoints/access_manager/grant_token.js"],"names":["getOperation","operationConstants","PNAccessManagerGrantToken","extractPermissions","permissions","permissionsResult","join","update","get","manage","write","read","prepareMessagePayload","modules","incomingParams","ttl","resources","patterns","meta","authorized_uuid","params","channels","groups","uuids","users","spaces","Object","keys","forEach","uuid","channel","group","validateParams","config","subscribeKey","publishKey","secretKey","length","postURL","usePost","getRequestTimeout","getTransactionTimeout","isAuthSupported","prepareParams","postPayload","handleResponse","response","token","data"],"mappings":"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","sourcesContent":["/* @flow */\n/* eslint camelcase: 0 */\n\nimport { GrantTokenInput, GrantTokenObject, ModulesInject } from '../../flow_interfaces';\nimport operationConstants from '../../constants/operations';\n\nexport function getOperation(): string {\n  return operationConstants.PNAccessManagerGrantToken;\n}\n\nexport function extractPermissions(permissions: GrantTokenObject) {\n  let permissionsResult = 0;\n\n  /* eslint-disable */\n\n  if (permissions.join) {\n    permissionsResult |= 128;\n  }\n\n  if (permissions.update) {\n    permissionsResult |= 64;\n  }\n\n  if (permissions.get) {\n    permissionsResult |= 32;\n  }\n\n  if (permissions.delete) {\n    permissionsResult |= 8;\n  }\n\n  if (permissions.manage) {\n    permissionsResult |= 4;\n  }\n\n  if (permissions.write) {\n    permissionsResult |= 2;\n  }\n\n  if (permissions.read) {\n    permissionsResult |= 1;\n  }\n\n  /* eslint-enable */\n\n  return permissionsResult;\n}\n\nfunction prepareMessagePayload(modules, incomingParams) {\n  const { ttl, resources, patterns, meta, authorized_uuid } = incomingParams;\n  const params: any = {\n    ttl: 0,\n    permissions: {\n      resources: {\n        channels: {},\n        groups: {},\n        uuids: {},\n        users: {}, // not used, needed for api backward compatibility\n        spaces: {} // not used, needed for api backward compatibility\n      },\n      patterns: {\n        channels: {},\n        groups: {},\n        uuids: {},\n        users: {}, // not used, needed for api backward compatibility\n        spaces: {} // not used, needed for api backward compatibility\n      },\n      meta: {}\n    }\n  };\n\n  if (resources) {\n    const { uuids, channels, groups } = resources;\n\n    if (uuids) {\n      Object.keys(uuids).forEach((uuid) => {\n        params.permissions.resources.uuids[uuid] = extractPermissions(uuids[uuid]);\n      });\n    }\n\n    if (channels) {\n      Object.keys(channels).forEach((channel) => {\n        params.permissions.resources.channels[channel] = extractPermissions(channels[channel]);\n      });\n    }\n\n    if (groups) {\n      Object.keys(groups).forEach((group) => {\n        params.permissions.resources.groups[group] = extractPermissions(groups[group]);\n      });\n    }\n  }\n\n  if (patterns) {\n    const { uuids, channels, groups } = patterns;\n\n    if (uuids) {\n      Object.keys(uuids).forEach((uuid) => {\n        params.permissions.patterns.uuids[uuid] = extractPermissions(uuids[uuid]);\n      });\n    }\n\n    if (channels) {\n      Object.keys(channels).forEach((channel) => {\n        params.permissions.patterns.channels[channel] = extractPermissions(channels[channel]);\n      });\n    }\n\n    if (groups) {\n      Object.keys(groups).forEach((group) => {\n        params.permissions.patterns.groups[group] = extractPermissions(groups[group]);\n      });\n    }\n  }\n\n  if (ttl || ttl === 0) {\n    params.ttl = ttl;\n  }\n\n  if (meta) {\n    params.permissions.meta = meta;\n  }\n\n  if (authorized_uuid) {\n    params.permissions.uuid = `${authorized_uuid}`; // ensure this is a string\n  }\n\n  return params;\n}\n\nexport function validateParams(\n  modules: ModulesInject,\n  incomingParams: GrantTokenInput\n) {\n  let { config } = modules;\n\n  if (!config.subscribeKey) return 'Missing Subscribe Key';\n  if (!config.publishKey) return 'Missing Publish Key';\n  if (!config.secretKey) return 'Missing Secret Key';\n\n  if (!incomingParams.resources && !incomingParams.patterns) return 'Missing either Resources or Patterns.';\n\n  if (\n    (\n      (incomingParams.resources) &&\n      (!incomingParams.resources.uuids || Object.keys(incomingParams.resources.uuids).length === 0) &&\n      (!incomingParams.resources.channels || Object.keys(incomingParams.resources.channels).length === 0) &&\n      (!incomingParams.resources.groups || Object.keys(incomingParams.resources.groups).length === 0)\n    ) ||\n    (\n      (incomingParams.patterns) &&\n      (!incomingParams.patterns.uuids || Object.keys(incomingParams.patterns.uuids).length === 0) &&\n      (!incomingParams.patterns.channels || Object.keys(incomingParams.patterns.channels).length === 0) &&\n      (!incomingParams.patterns.groups || Object.keys(incomingParams.patterns.groups).length === 0)\n    )\n  ) {\n    return 'Missing values for either Resources or Patterns.';\n  }\n}\n\nexport function postURL(modules: ModulesInject): string {\n  let { config } = modules;\n  return `/v3/pam/${config.subscribeKey}/grant`;\n}\n\nexport function usePost() {\n  return true;\n}\n\nexport function getRequestTimeout({ config }: ModulesInject): number {\n  return config.getTransactionTimeout();\n}\n\nexport function isAuthSupported(): boolean {\n  return false;\n}\n\nexport function prepareParams(): Object {\n  return {};\n}\n\nexport function postPayload(\n  modules: ModulesInject,\n  incomingParams: GrantTokenInput\n): Object {\n  return prepareMessagePayload(modules, incomingParams);\n}\n\nexport function handleResponse(\n  modules: ModulesInject,\n  response: Object\n): string {\n  let token = response.data.token;\n\n  return token;\n}\n"],"file":"grant_token.js"}