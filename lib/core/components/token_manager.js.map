{"version":3,"sources":["core/components/token_manager.js"],"names":["config","cbor","_config","_cbor","token","length","_token","undefined","permissions","permissionsResult","read","write","manage","get","update","join","tokenString","parsed","decodeToken","uuidResourcePermissions","res","uuid","Object","keys","channelResourcePermissions","chan","groupResourcePermissions","grp","uuidPatternPermissions","pat","channelPatternPermissions","groupPatternPermissions","result","version","v","timestamp","t","ttl","authorized_uuid","uuidResources","channelResources","groupResources","resources","uuids","forEach","id","extractPermissions","channels","groups","uuidPatterns","channelPatterns","groupPatterns","patterns","meta","signature","sig"],"mappings":"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","sourcesContent":["/* @flow */\nimport Config from './config';\nimport {\n  GrantTokenOutput,\n} from '../flow_interfaces';\n\nexport default class {\n  _config: Config;\n\n  _cbor: any;\n\n  _token: any;\n\n  constructor(config: Config, cbor: any) {\n    this._config = config;\n    this._cbor = cbor;\n  }\n\n  setToken(token: string) {\n    if (token && token.length > 0) {\n      this._token = token;\n    } else {\n      this._token = undefined;\n    }\n  }\n\n  getToken() {\n    return this._token;\n  }\n\n  extractPermissions(permissions: number) {\n    let permissionsResult = {\n      read: false,\n      write: false,\n      manage: false,\n      delete: false,\n      get: false,\n      update: false,\n      join: false\n    };\n\n    /* eslint-disable */\n\n    if ((permissions & 128) === 128) {\n      permissionsResult.join = true;\n    }\n\n    if ((permissions & 64) === 64) {\n      permissionsResult.update = true;\n    }\n\n    if ((permissions & 32) === 32) {\n      permissionsResult.get = true;\n    }\n\n    if ((permissions & 8) === 8) {\n      permissionsResult.delete = true;\n    }\n\n    if ((permissions & 4) === 4) {\n      permissionsResult.manage = true;\n    }\n    \n    if ((permissions & 2) === 2) {\n      permissionsResult.write = true;\n    }\n    \n    if ((permissions & 1) === 1) {\n      permissionsResult.read = true;\n    }\n    \n    /* eslint-enable */\n\n    return permissionsResult;\n  }\n\n  parseToken(tokenString: string): GrantTokenOutput {\n    let parsed = this._cbor.decodeToken(tokenString);\n\n    if (parsed !== undefined) {\n      let uuidResourcePermissions = parsed.res.uuid ? Object.keys(parsed.res.uuid) : [];\n      let channelResourcePermissions = Object.keys(parsed.res.chan);\n      let groupResourcePermissions = Object.keys(parsed.res.grp);\n      let uuidPatternPermissions = parsed.pat.uuid ? Object.keys(parsed.pat.uuid) : [];\n      let channelPatternPermissions = Object.keys(parsed.pat.chan);\n      let groupPatternPermissions = Object.keys(parsed.pat.grp);\n\n      let result: GrantTokenOutput  = {\n        version: parsed.v,\n        timestamp: parsed.t,\n        ttl: parsed.ttl,\n        authorized_uuid: parsed.uuid\n      };\n\n      let uuidResources = uuidResourcePermissions.length > 0;\n      let channelResources = channelResourcePermissions.length > 0;\n      let groupResources = groupResourcePermissions.length > 0;\n\n      if (uuidResources || channelResources || groupResources) {\n        result.resources = {};\n\n        if (uuidResources) {\n          result.resources.uuids = {};\n          uuidResourcePermissions.forEach((id) => {\n            result.resources.uuids[id] = this.extractPermissions(parsed.res.uuid[id]);\n          });\n        }\n\n        if (channelResources) {\n          result.resources.channels = {};\n          channelResourcePermissions.forEach((id) => {\n            result.resources.channels[id] = this.extractPermissions(parsed.res.chan[id]);\n          });\n        }\n\n        if (groupResources) {\n          result.resources.groups = {};\n          groupResourcePermissions.forEach((id) => {\n            result.resources.groups[id] = this.extractPermissions(parsed.res.grp[id]);\n          });\n        }\n      }\n\n      let uuidPatterns = uuidPatternPermissions.length > 0;\n      let channelPatterns = channelPatternPermissions.length > 0;\n      let groupPatterns = groupPatternPermissions.length > 0;\n\n      if (uuidPatterns || channelPatterns || groupPatterns) {\n        result.patterns = {};\n\n        if (uuidPatterns) {\n          result.patterns.uuids = {};\n          uuidPatternPermissions.forEach((id) => {\n            result.patterns.uuids[id] = this.extractPermissions(parsed.pat.uuid[id]);\n          });\n        }\n\n        if (channelPatterns) {\n          result.patterns.channels = {};\n          channelPatternPermissions.forEach((id) => {\n            result.patterns.channels[id] = this.extractPermissions(parsed.pat.chan[id]);\n          });\n        }\n\n        if (groupPatterns) {\n          result.patterns.groups = {};\n          groupPatternPermissions.forEach((id) => {\n            result.patterns.groups[id] = this.extractPermissions(parsed.pat.grp[id]);\n          });\n        }\n      }\n\n      if (Object.keys(parsed.meta).length > 0) {\n        result.meta = parsed.meta;\n      }\n\n      result.signature = parsed.sig;\n\n      return result;\n    } else {\n      return undefined;\n    }\n  }\n}\n"],"file":"token_manager.js"}