{"version":3,"sources":["core/components/config.js"],"names":["setup","db","_db","instanceId","v4","secretKey","subscribeKey","publishKey","sdkFamily","partnerId","setAuthKey","authKey","setCipherKey","cipherKey","setFilterExpression","filterExpression","origin","secure","ssl","restore","location","protocol","logVerbosity","suppressLeaveEvents","announceFailedHeartbeats","announceSuccessfulHeartbeats","useInstanceId","useRequestId","requestMessageCountThreshold","setTransactionTimeout","transactionalRequestTimeout","setSubscribeTimeout","subscribeRequestTimeout","setSendBeaconConfig","useSendBeacon","setPresenceTimeout","presenceTimeout","heartbeatInterval","setHeartbeatInterval","setUUID","_decideUUID","uuid","val","UUID","set","_presenceTimeout","_heartbeatInterval","_subscribeRequestTimeout","_transactionalRequestTimeout","_useSendBeacon","providedUUID","get"],"mappings":"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","file":"config.js","sourcesContent":["/* @flow */\n/* global location */\n\nimport uuidGenerator from 'uuid';\nimport { InternalSetupStruct, DatabaseInterface } from '../flow_interfaces';\n\ntype ConfigConstructArgs = {\n  setup: InternalSetupStruct,\n  db: DatabaseInterface\n}\n\nexport default class {\n\n  _db: DatabaseInterface;\n\n  subscribeKey: string;\n  publishKey: string;\n  secretKey: string;\n  cipherKey: string;\n  authKey: string;\n  UUID: string;\n\n  /*\n    if _useInstanceId is true, this instanceId will be added to all requests\n  */\n  instanceId: string;\n\n  /*\n    keep track of the SDK family for identifier generator\n  */\n  sdkFamily: string;\n\n  /*\n    If the SDK is operated by a partner, allow a custom pnsdk item for them.\n  */\n  partnerId: string;\n\n  /*\n    filter expression to pass along when subscribing.\n  */\n  filterExpression: string;\n  /*\n    configuration to supress leave events; when a presence leave is performed\n    this configuration will disallow the leave event from happening\n  */\n  suppressLeaveEvents: boolean;\n\n  /*\n    use SSL for http requests?\n  */\n  secure: boolean;\n\n  // Custom optional origin.\n  origin: string;\n\n  // log verbosity: true to output lots of info\n  logVerbosity: boolean;\n\n  // if instanceId config is true, the SDK will pass the unique instance identifier to the server as instanceId=<UUID>\n  useInstanceId: boolean;\n\n  // if requestId config is true, the SDK will pass a unique request identifier with each request as request_id=<UUID>\n  useRequestId: boolean;\n\n  // alert when a heartbeat works out.\n  announceSuccessfulHeartbeats: boolean;\n  announceFailedHeartbeats: boolean;\n\n  /*\n    how long the server will wait before declaring that the client is gone.\n  */\n  _presenceTimeout: number;\n\n  /*\n    how often (in seconds) the client should announce its presence to server\n  */\n  _heartbeatInterval: number;\n\n  /*\n    how long to wait for the server when running the subscribe loop\n  */\n  _subscribeRequestTimeout: number;\n  /*\n    how long to wait for the server when making transactional requests\n  */\n  _transactionalRequestTimeout: number;\n  /*\n    use send beacon API when unsubscribing.\n    https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon\n  */\n  _useSendBeacon: boolean;\n\n  /*\n    if set, the SDK will alert if more messages arrive in one subscribe than the theshold\n  */\n  requestMessageCountThreshold: number;\n\n  /*\n    Restore subscription list on disconnection.\n   */\n  restore: boolean;\n\n\n  constructor({ setup, db } : ConfigConstructArgs) {\n    this._db = db;\n\n    this.instanceId = uuidGenerator.v4();\n    this.secretKey = setup.secretKey;\n    this.subscribeKey = setup.subscribeKey;\n    this.publishKey = setup.publishKey;\n    this.sdkFamily = setup.sdkFamily;\n    this.partnerId = setup.partnerId;\n    this.setAuthKey(setup.authKey);\n    this.setCipherKey(setup.cipherKey);\n\n    this.setFilterExpression(setup.filterExpression);\n\n    this.origin = setup.origin || 'pubsub.pubnub.com';\n    this.secure = setup.ssl || false;\n    this.restore = setup.restore || false;\n\n    // if location config exist and we are in https, force secure to true.\n    if (typeof location !== 'undefined' && location.protocol === 'https:') {\n      this.secure = true;\n    }\n\n    this.logVerbosity = setup.logVerbosity || false;\n    this.suppressLeaveEvents = setup.suppressLeaveEvents || false;\n\n    this.announceFailedHeartbeats = setup.announceFailedHeartbeats || true;\n    this.announceSuccessfulHeartbeats = setup.announceSuccessfulHeartbeats || false;\n\n    this.useInstanceId = setup.useInstanceId || false;\n    this.useRequestId = setup.useRequestId || false;\n\n    this.requestMessageCountThreshold = setup.requestMessageCountThreshold;\n\n    // set timeout to how long a transaction request will wait for the server (default 15 seconds)\n    this.setTransactionTimeout(setup.transactionalRequestTimeout || 15 * 1000);\n    // set timeout to how long a subscribe event loop will run (default 310 seconds)\n    this.setSubscribeTimeout(setup.subscribeRequestTimeout || 310 * 1000);\n    // set config on beacon (https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon) usage\n    this.setSendBeaconConfig(setup.useSendBeacon || true);\n    // how long the SDK will report the client to be alive before issuing a timeout\n    this.setPresenceTimeout(setup.presenceTimeout || 300);\n\n    if (setup.heartbeatInterval) {\n      this.setHeartbeatInterval(setup.heartbeatInterval);\n    }\n\n    this.setUUID(this._decideUUID(setup.uuid)); // UUID decision depends on subKey.\n  }\n\n  // exposed setters\n  getAuthKey(): string { return this.authKey; }\n  setAuthKey(val: string): this { this.authKey = val; return this; }\n  setCipherKey(val: string): this { this.cipherKey = val; return this; }\n  getUUID(): string { return this.UUID; }\n  setUUID(val: string): this {\n    if (this._db && this._db.set) this._db.set(this.subscribeKey + 'uuid', val);\n    this.UUID = val;\n    return this;\n  }\n\n  getFilterExpression(): string { return this.filterExpression; }\n  setFilterExpression(val: string): this { this.filterExpression = val; return this; }\n\n  getPresenceTimeout(): number { return this._presenceTimeout; }\n  setPresenceTimeout(val: number): this {\n    this._presenceTimeout = val;\n    this.setHeartbeatInterval((this._presenceTimeout / 2) - 1);\n    return this;\n  }\n\n  getHeartbeatInterval(): number { return this._heartbeatInterval; }\n  setHeartbeatInterval(val: number): this { this._heartbeatInterval = val; return this; }\n\n  // deprecated setters.\n  getSubscribeTimeout(): number { return this._subscribeRequestTimeout; }\n  setSubscribeTimeout(val: number): this { this._subscribeRequestTimeout = val; return this; }\n\n  getTransactionTimeout(): number { return this._transactionalRequestTimeout; }\n  setTransactionTimeout(val: number): this { this._transactionalRequestTimeout = val; return this; }\n\n  isSendBeaconEnabled(): boolean { return this._useSendBeacon; }\n  setSendBeaconConfig(val: boolean): this { this._useSendBeacon = val; return this; }\n\n  getVersion(): string {\n    return '4.3.3';\n  }\n\n  _decideUUID(providedUUID: string): string {\n    // if the uuid was provided by setup, use this UUID.\n    if (providedUUID) {\n      return providedUUID;\n    }\n\n    // if the database module is enabled and we have something saved, use this.\n    if (this._db && this._db.get && this._db.get(this.subscribeKey + 'uuid')) {\n      return this._db.get(this.subscribeKey + 'uuid');\n    }\n\n    // randomize the UUID and push to storage\n    return uuidGenerator.v4();\n  }\n\n}\n"]}