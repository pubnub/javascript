{"version":3,"sources":["core/components/cryptography/index.js"],"names":["config","_config","_iv","_allowedKeyEncodings","_allowedKeyLengths","_allowedModes","_defaultOptions","encryptKey","keyEncoding","keyLength","mode","data","hash","CryptoJS","HmacSHA256","secretKey","toString","enc","Base64","s","SHA256","Hex","incomingOptions","options","hasOwnProperty","indexOf","toLowerCase","parseInt","key","parse","_decodeKey","Utf8","slice","ECB","CBC","customCipherKey","customEncrypt","pnEncrypt","customDecrypt","pnDecrypt","cipherKey","_parseOptions","iv","_getIV","_getMode","_getPaddedKey","encryptedHexArray","AES","encrypt","ciphertext","base64Encrypted","plainJSON","decrypt","plaintext","JSON","e"],"mappings":"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","file":"index.js","sourcesContent":["/* @flow */\r\n\r\nimport Config from '../config';\r\nimport CryptoJS from './hmac-sha256';\r\n\r\ntype CryptoConstruct = {\r\n  config: Config,\r\n}\r\n\r\nexport default class {\r\n\r\n  _config: Config;\r\n  _iv: string;\r\n  _allowedKeyEncodings: Array<string>;\r\n  _allowedKeyLengths: Array<number>;\r\n  _allowedModes: Array<string>;\r\n  _defaultOptions: Object;\r\n\r\n  constructor({ config }: CryptoConstruct) {\r\n    this._config = config;\r\n\r\n    this._iv = '0123456789012345';\r\n\r\n    this._allowedKeyEncodings = ['hex', 'utf8', 'base64', 'binary'];\r\n    this._allowedKeyLengths = [128, 256];\r\n    this._allowedModes = ['ecb', 'cbc'];\r\n\r\n    this._defaultOptions = {\r\n      encryptKey: true,\r\n      keyEncoding: 'utf8',\r\n      keyLength: 256,\r\n      mode: 'cbc'\r\n    };\r\n  }\r\n\r\n  HMACSHA256(data: string): string {\r\n    let hash = CryptoJS.HmacSHA256(data, this._config.secretKey);\r\n    return hash.toString(CryptoJS.enc.Base64);\r\n  }\r\n\r\n  SHA256(s: string): string {\r\n    return CryptoJS.SHA256(s).toString(CryptoJS.enc.Hex);\r\n  }\r\n\r\n  _parseOptions(incomingOptions: ?Object): Object {\r\n    // Defaults\r\n    let options = incomingOptions || {};\r\n    if (!options.hasOwnProperty('encryptKey')) options.encryptKey = this._defaultOptions.encryptKey;\r\n    if (!options.hasOwnProperty('keyEncoding')) options.keyEncoding = this._defaultOptions.keyEncoding;\r\n    if (!options.hasOwnProperty('keyLength')) options.keyLength = this._defaultOptions.keyLength;\r\n    if (!options.hasOwnProperty('mode')) options.mode = this._defaultOptions.mode;\r\n\r\n    // Validation\r\n    if (this._allowedKeyEncodings.indexOf(options.keyEncoding.toLowerCase()) === -1) {\r\n      options.keyEncoding = this._defaultOptions.keyEncoding;\r\n    }\r\n\r\n    if (this._allowedKeyLengths.indexOf(parseInt(options.keyLength, 10)) === -1) {\r\n      options.keyLength = this._defaultOptions.keyLength;\r\n    }\r\n\r\n    if (this._allowedModes.indexOf(options.mode.toLowerCase()) === -1) {\r\n      options.mode = this._defaultOptions.mode;\r\n    }\r\n\r\n    return options;\r\n  }\r\n\r\n  _decodeKey(key: string, options: Object): string {\r\n    if (options.keyEncoding === 'base64') {\r\n      return CryptoJS.enc.Base64.parse(key);\r\n    } else if (options.keyEncoding === 'hex') {\r\n      return CryptoJS.enc.Hex.parse(key);\r\n    } else {\r\n      return key;\r\n    }\r\n  }\r\n\r\n  _getPaddedKey(key: string, options: Object): string {\r\n    key = this._decodeKey(key, options);\r\n    if (options.encryptKey) {\r\n      return CryptoJS.enc.Utf8.parse(this.SHA256(key).slice(0, 32));\r\n    } else {\r\n      return key;\r\n    }\r\n  }\r\n\r\n  _getMode(options: Object): string {\r\n    if (options.mode === 'ecb') {\r\n      return CryptoJS.mode.ECB;\r\n    } else {\r\n      return CryptoJS.mode.CBC;\r\n    }\r\n  }\r\n\r\n  _getIV(options: Object): string | null {\r\n    return (options.mode === 'cbc') ? CryptoJS.enc.Utf8.parse(this._iv) : null;\r\n  }\r\n\r\n  encrypt(data: string, customCipherKey: ?string, options: ?Object): Object | string | null {\r\n    if (this._config.customEncrypt) {\r\n      return this._config.customEncrypt(data);\r\n    } else {\r\n      return this.pnEncrypt(data, customCipherKey, options);\r\n    }\r\n  }\r\n\r\n  decrypt(data: Object, customCipherKey: ?string, options: ?Object): Object | string | null {\r\n    if (this._config.customDecrypt) {\r\n      return this._config.customDecrypt(data);\r\n    } else {\r\n      return this.pnDecrypt(data, customCipherKey, options);\r\n    }\r\n  }\r\n\r\n  pnEncrypt(data: string, customCipherKey: ?string, options: ?Object): Object | string | null {\r\n    if (!customCipherKey && !this._config.cipherKey) return data;\r\n    options = this._parseOptions(options);\r\n    let iv = this._getIV(options);\r\n    let mode = this._getMode(options);\r\n    let cipherKey = this._getPaddedKey(customCipherKey || this._config.cipherKey, options);\r\n    let encryptedHexArray = CryptoJS.AES.encrypt(data, cipherKey, { iv, mode }).ciphertext;\r\n    let base64Encrypted = encryptedHexArray.toString(CryptoJS.enc.Base64);\r\n    return base64Encrypted || data;\r\n  }\r\n\r\n  pnDecrypt(data: Object, customCipherKey: ?string, options: ?Object): Object | null {\r\n    if (!customCipherKey && !this._config.cipherKey) return data;\r\n    options = this._parseOptions(options);\r\n    let iv = this._getIV(options);\r\n    let mode = this._getMode(options);\r\n    let cipherKey = this._getPaddedKey(customCipherKey || this._config.cipherKey, options);\r\n    try {\r\n      let ciphertext = CryptoJS.enc.Base64.parse(data);\r\n      let plainJSON = CryptoJS.AES.decrypt({ ciphertext }, cipherKey, { iv, mode }).toString(CryptoJS.enc.Utf8);\r\n      let plaintext = JSON.parse(plainJSON);\r\n      return plaintext;\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n}\r\n"]}