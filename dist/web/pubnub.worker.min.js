!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function c(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,c)}u((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n,i,r={exports:{}};
/*! lil-uuid - v0.1 - MIT License - https://github.com/lil-js/uuid */n=r,function(e){var t="0.1.0",n={3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,all:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i};function i(){var e,t,n="";for(e=0;e<32;e++)t=16*Math.random()|0,8!==e&&12!==e&&16!==e&&20!==e||(n+="-"),n+=(12===e?4:16===e?3&t|8:t).toString(16);return n}function r(e,t){var i=n[t||"all"];return i&&i.test(e)||!1}i.isUUID=r,i.VERSION=t,e.uuid=i,e.isUUID=r}(i=r.exports),null!==n&&(n.exports=i.uuid);var s=t(r.exports),o={createUUID:()=>s.uuid?s.uuid():s()};const c=1e4,u=new Map,l=new TextDecoder;let a,d=!1;const f=o.createUUID(),p=new Map,h={},g={},b={},v={},y={};self.onconnect=e=>{z("New PubNub Client connected to the Subscription Shared Worker."),e.ports.forEach((e=>{e.start(),e.onmessage=t=>{if(!D(t))return;const n=t.data;if("client-register"===n.type)!d&&n.workerLogVerbosity&&(d=!0),n.port=e,C(n),z(`Client '${n.clientIdentifier}' registered with '${f}' shared worker`);else if("client-pong"===n.type)W(n);else if("send-request"===n.type)if(n.request.path.startsWith("/v2/subscribe")){U(n);const e=h[n.clientIdentifier];if(e){const t=`${e.userId}-${e.subscriptionKey}`;if(!u.has(t)){const e=setTimeout((()=>{q(n),u.delete(t)}),50);u.set(t,e)}}}else m(n);else"cancel-request"===n.type&&j(n)},e.postMessage({type:"shared-worker-connected"})}))};const q=e=>{var t;const n=R(e),i=h[e.clientIdentifier];let r=!1;if(i&&(i.subscription&&(r="0"===i.subscription.timetoken),x("start",[i],(new Date).toISOString())),"string"==typeof n){const s=y[n];if(i){if(i.subscription&&(i.subscription.timetoken=s.timetoken,i.subscription.region=s.region,i.subscription.serviceRequestId=n),!r)return;const o=(new TextEncoder).encode(`{"t":{"t":"${s.timetoken}","r":${null!==(t=s.region)&&void 0!==t?t:"0"}},"m":[]}`),c=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${o.length}`}),u=new Response(o,{status:200,headers:c}),l=G([u,o]);l.url=`${e.request.origin}${e.request.path}`,l.clientIdentifier=e.clientIdentifier,l.identifier=e.request.identifier,x("end",[i],(new Date).toISOString(),e.request,o,c.get("Content-Type"),0),T(i,l)}return}e.request.cancellable&&p.set(n.identifier,new AbortController);const s=y[n.identifier],{timetokenOverride:o,regionOverride:c}=s;O(n,(()=>S(n.identifier)),((e,t)=>{F(e,t),E(e,n.identifier)}),((e,t)=>{F(e,null,n,K(t)),E(e,n.identifier)}),(e=>{let t=e;return r&&o&&"0"!==o&&(y[n.identifier],t=I(t,o,c)),t})),z(`'${Object.keys(y).length}' subscription request currently active.`)},I=(e,t,n)=>{if(void 0===t||"0"===t||e[0].status>=400)return e;let i;const r=e[0];let s=r,o=e[1];try{i=JSON.parse((new TextDecoder).decode(o))}catch(t){return z(`Subscribe response parse error: ${t}`),e}i.t.t=t,n&&(i.t.r=parseInt(n,10));try{if(o=(new TextEncoder).encode(JSON.stringify(i)).buffer,o.byteLength){const e=new Headers(r.headers);e.set("Content-Length",`${o.byteLength}`),s=new Response(o,{status:r.status,statusText:r.statusText,headers:e})}}catch(t){return z(`Subscribe serialization error: ${t}`),e}return o.byteLength>0?[s,o]:e},m=e=>{const t=h[e.clientIdentifier],n=A(e);if(!t)return;const{subscription:i}=t,r=null==i?void 0:i.serviceRequestId;if(i&&0===i.channels.length&&0===i.channelGroups.length&&(i.channelGroupQuery="",i.path="",i.previousTimetoken="0",i.timetoken="0",delete i.region,delete i.serviceRequestId,delete i.request),!n){const n=(new TextEncoder).encode('{"status": 200, "action": "leave", "message": "OK", "service":"Presence"}'),i=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${n.length}`}),r=new Response(n,{status:200,headers:i}),s=G([r,n]);return s.url=`${e.request.origin}${e.request.path}`,s.clientIdentifier=e.clientIdentifier,s.identifier=e.request.identifier,void T(t,s)}if(O(n,(()=>[t]),((t,n)=>{F(t,n,e.request)}),((t,n)=>{F(t,null,e.request,K(n))})),z("Started leave request.",t),void 0===r)return;const s=S(r);s.forEach((e=>{e&&e.subscription&&delete e.subscription.serviceRequestId})),$(r),w(s)},j=e=>{const t=h[e.clientIdentifier];if(!t||!t.subscription)return;const n=t.subscription.serviceRequestId;t&&n&&(delete t.subscription.serviceRequestId,t.subscription.request&&t.subscription.request.identifier===e.identifier&&delete t.subscription.request,$(n))},w=e=>{let t,n;for(const i of e)if(i.subscription&&i.subscription.request){n=i.subscription.request,t=i;break}n&&t&&q({type:"send-request",clientIdentifier:t.clientIdentifier,subscriptionKey:t.subscriptionKey,logVerbosity:t.logVerbosity,request:n})},O=(t,n,i,r,s)=>{e(void 0,void 0,void 0,(function*(){var e;const o=(new Date).getTime();Promise.race([fetch(P(t),{signal:null===(e=p.get(t.identifier))||void 0===e?void 0:e.signal,keepalive:!0}),k(t.identifier,t.timeout)]).then((e=>e.arrayBuffer().then((t=>[e,t])))).then((e=>s?s(e):e)).then((e=>{const r=e[1].byteLength>0?e[1]:void 0,s=n();0!==s.length&&(x("end",s,(new Date).toISOString(),t,r,e[0].headers.get("Content-Type"),(new Date).getTime()-o),i(s,e))})).catch((e=>{const t=n();0!==t.length&&r(t,e)}))}))},$=e=>{if(0===S(e).length){const t=p.get(e);p.delete(e),delete y[e],t&&t.abort()}},k=(e,t)=>new Promise(((n,i)=>{const r=setTimeout((()=>{p.delete(e),clearTimeout(r),i(new Error("Request timeout"))}),1e3*t)})),S=e=>Object.values(h).filter((t=>void 0!==t&&void 0!==t.subscription&&t.subscription.serviceRequestId===e)),E=(e,t)=>{delete y[t],e.forEach((e=>{e.subscription&&(delete e.subscription.request,delete e.subscription.serviceRequestId)}))},P=e=>{let t;const n=e.queryParameters;let i=e.path;if(e.headers){t={};for(const[n,i]of Object.entries(e.headers))t[n]=i}return n&&0!==Object.keys(n).length&&(i=`${i}?${_(n)}`),new Request(`${e.origin}${i}`,{method:e.method,headers:t,redirect:"follow"})},R=e=>{var t,n,i,r,s;const c=h[e.clientIdentifier],u=c.subscription,l=N(u.timetoken,e),a=o.createUUID(),f=Object.assign({},e.request);let p,g;if(l.length>1){const s=L(l,e);if(s){const e=y[s],{channels:n,channelGroups:i}=null!==(t=c.subscription)&&void 0!==t?t:{channels:[],channelGroups:[]};if((!(n.length>0)||Q(e.channels,n))&&(!(i.length>0)||Q(e.channelGroups,i)))return s}const o=(null!==(n=b[c.subscriptionKey])&&void 0!==n?n:{})[c.userId],d={},h=new Set(u.channelGroups),v=new Set(u.channels);o&&u.objectsWithState.length&&u.objectsWithState.forEach((e=>{const t=o[e];t&&(d[e]=t)}));for(const e of l){const{subscription:t}=e;if(!t)continue;1!==l.length&&e.clientIdentifier===c.clientIdentifier||!t.timetoken||(p=t.timetoken,g=t.region),t.channelGroups.forEach(h.add,h),t.channels.forEach(v.add,v);const n=t.serviceRequestId;t.serviceRequestId=a,n&&y[n]&&$(n),o&&t.objectsWithState.forEach((e=>{const t=o[e];t&&!d[e]&&(d[e]=t)}))}const q=null!==(i=y[a])&&void 0!==i?i:y[a]={requestId:a,timetoken:null!==(r=f.queryParameters.tt)&&void 0!==r?r:"0",channelGroups:[],channels:[]};if(v.size){q.channels=Array.from(v).sort();const e=f.path.split("/");e[4]=q.channels.join(","),f.path=e.join("/")}h.size&&(q.channelGroups=Array.from(h).sort(),f.queryParameters["channel-group"]=q.channelGroups.join(",")),Object.keys(d).length&&(f.queryParameters.state=JSON.stringify(d))}else y[a]={requestId:a,timetoken:null!==(s=f.queryParameters.tt)&&void 0!==s?s:"0",channelGroups:u.channelGroups,channels:u.channels};if(y[a]&&(f.queryParameters&&void 0!==f.queryParameters.tt&&void 0!==f.queryParameters.tr&&(y[a].region=f.queryParameters.tr),y[a].timetokenOverride=p,y[a].regionOverride=g),u.serviceRequestId=a,f.identifier=a,d){const e=l.reduce(((e,{clientIdentifier:t})=>(e.push(t),e)),[]).join(",");H(y[a],`Started aggregated request for clients: ${e}`)}return f},A=e=>{const t=h[e.clientIdentifier],n=M(e);let i=J(e.request),r=V(e.request);const s=Object.assign({},e.request);if(t&&t.subscription){const{subscription:e}=t;r.length&&(e.channels=e.channels.filter((e=>!r.includes(e)))),i.length&&(e.channelGroups=e.channelGroups.filter((e=>!i.includes(e))))}for(const t of n){const n=t.subscription;void 0!==n&&(t.clientIdentifier!==e.clientIdentifier&&(r.length&&(r=r.filter((e=>!n.channels.includes(e)))),i.length&&(i=i.filter((e=>!n.channelGroups.includes(e))))))}if(0!==r.length||0!==i.length){if(r.length){const e=s.path.split("/");e[6]=r.join(","),s.path=e.join("/")}return i.length&&(s.queryParameters["channel-group"]=i.join(",")),s}if(d&&t){const e=n.reduce(((e,{clientIdentifier:t})=>(e.push(t),e)),[]).join(",");z(`Specified channels and groups still in use by other clients: ${e}. Ignoring leave request.`,t)}},T=(e,t)=>{var n;const i=(null!==(n=v[e.subscriptionKey])&&void 0!==n?n:{})[e.clientIdentifier];if(!i)return!1;try{return i.postMessage(t),!0}catch(e){}return!1},x=(e,t,n,i,r,s,o)=>{var c;if(0===t.length)return;const u=null!==(c=v[t[0].subscriptionKey])&&void 0!==c?c:{};let a;if("start"===e)a={type:"request-progress-start",clientIdentifier:"",url:"",timestamp:n};else{let e;r&&s&&(-1!==s.indexOf("text/javascript")||-1!==s.indexOf("application/json")||-1!==s.indexOf("text/plain")||-1!==s.indexOf("text/html"))&&(e=l.decode(r)),a={type:"request-progress-end",clientIdentifier:"",url:"",response:e,timestamp:n,duration:o}}for(const e of t){if(void 0===e.subscription)continue;const t=u[e.clientIdentifier],{request:n}=e.subscription,r=null!=n?n:i;if(e.logVerbosity&&t&&r){const t=Object.assign(Object.assign({},a),{clientIdentifier:e.clientIdentifier,url:`${r.origin}${r.path}`,query:r.queryParameters});T(e,t)}}},F=(e,t,n,i)=>{var r;if(0===e.length)return;if(!i&&!t)return;const s=null!==(r=v[e[0].subscriptionKey])&&void 0!==r?r:{};!i&&t&&(i=t[0].status>=400?K(void 0,t):G(t));for(const t of e){if(void 0===t.subscription)continue;const e=s[t.clientIdentifier],{request:r}=t.subscription,o=null!=r?r:n;if(e&&o){const e=Object.assign(Object.assign({},i),{clientIdentifier:t.clientIdentifier,identifier:o.identifier,url:`${o.origin}${o.path}`});T(t,e)}}},G=e=>{var t;const[n,i]=e,r=i.byteLength>0?i:void 0,s=parseInt(null!==(t=n.headers.get("Content-Length"))&&void 0!==t?t:"0",10),o=n.headers.get("Content-Type"),c={};return n.headers.forEach(((e,t)=>c[t]=e.toLowerCase())),{type:"request-process-success",clientIdentifier:"",identifier:"",url:"",response:{contentLength:s,contentType:o,headers:c,status:n.status,body:r}}},K=(e,t)=>{if(t)return Object.assign(Object.assign({},G(t)),{type:"request-process-error"});let n="NETWORK_ISSUE",i="Unknown error",r="Error";return e&&e instanceof Error&&(i=e.message,r=e.name),"AbortError"===r?(i="Request aborted",n="ABORTED"):"Request timeout"===i&&(n="TIMEOUT"),{type:"request-process-error",clientIdentifier:"",identifier:"",url:"",error:{name:r,type:n,message:i}}},C=e=>{var t,n,i,r;const{clientIdentifier:s}=e;if(h[s])return;const o=h[s]={clientIdentifier:s,subscriptionKey:e.subscriptionKey,userId:e.userId,logVerbosity:e.logVerbosity},u=null!==(t=g[i=e.subscriptionKey])&&void 0!==t?t:g[i]=[];u.every((e=>e.clientIdentifier!==s))&&u.push(o),(null!==(n=v[r=e.subscriptionKey])&&void 0!==n?n:v[r]={})[s]=e.port,z(`Registered PubNub client with '${s}' identifier. '${Object.keys(h).length}' clients currently active.`),!a&&Object.keys(h).length>0&&(z("Setup PubNub client ping event 10 seconds"),a=setInterval((()=>B()),c))},U=e=>{var t,n,i,r,s,o,c,u,l,a,d,f,p,g,v,y,q,I,m,j;const w=e.request.queryParameters,{clientIdentifier:O}=e,$=h[O];if(!$)return;const k=null!==(t=w["channel-group"])&&void 0!==t?t:"",S=null!==(n=w.state)&&void 0!==n?n:"";let E=$.subscription;if(E){if(S.length>0){const e=JSON.parse(S),t=null!==(o=(y=null!==(s=b[v=$.subscriptionKey])&&void 0!==s?s:b[v]={})[q=$.userId])&&void 0!==o?o:y[q]={};Object.entries(e).forEach((([e,n])=>t[e]=n));for(const n of E.objectsWithState)e[n]||delete t[n];E.objectsWithState=Object.keys(e)}else if(E.objectsWithState.length){const e=null!==(u=(m=null!==(c=b[I=$.subscriptionKey])&&void 0!==c?c:b[I]={})[j=$.userId])&&void 0!==u?u:m[j]={};for(const t of E.objectsWithState)delete e[t];E.objectsWithState=[]}}else{if(E={path:"",channelGroupQuery:"",channels:[],channelGroups:[],previousTimetoken:"0",timetoken:"0",objectsWithState:[]},S.length>0){const e=JSON.parse(S),t=null!==(r=(p=null!==(i=b[f=$.subscriptionKey])&&void 0!==i?i:b[f]={})[g=$.userId])&&void 0!==r?r:p[g]={};Object.entries(e).forEach((([e,n])=>t[e]=n)),E.objectsWithState=Object.keys(e)}$.subscription=E}E.path!==e.request.path&&(E.path=e.request.path,E.channels=V(e.request)),E.channelGroupQuery!==k&&(E.channelGroupQuery=k,E.channelGroups=J(e.request)),E.request=e.request,E.filterExpression=null!==(l=w["filter-expr"])&&void 0!==l?l:"",E.timetoken=null!==(a=w.tt)&&void 0!==a?a:"0",void 0!==w.tr&&(E.region=w.tr),$.authKey=null!==(d=w.auth)&&void 0!==d?d:"",$.userId=w.uuid},W=e=>{const t=h[e.clientIdentifier];t&&(t.lastPongEvent=(new Date).getTime()/1e3)},D=e=>{const{clientIdentifier:t,subscriptionKey:n,logVerbosity:i}=e.data;return void 0!==i&&"boolean"==typeof i&&(!(!t||"string"!=typeof t)&&!(!n||"string"!=typeof n))},L=(e,t)=>{var n;const i=null!==(n=t.request.queryParameters["channel-group"])&&void 0!==n?n:"",r=t.request.path;let s,o;for(const n of e){const{subscription:e}=n;if(!e||!e.serviceRequestId)continue;const c=h[t.clientIdentifier],u=e.serviceRequestId;if(e.path===r&&e.channelGroupQuery===i)return z(`Found identical request started by '${n.clientIdentifier}' client. \nWaiting for existing '${u}' request completion.`,c),e.serviceRequestId;{const i=y[e.serviceRequestId];if(s||(s=J(t.request)),o||(o=V(t.request)),o.length&&!Q(i.channels,o))continue;if(s.length&&!Q(i.channelGroups,s))continue;return H(i,`'${t.request.identifier}' request channels and groups are subset of ongoing '${u}' request \nwhich has started by '${n.clientIdentifier}' client. Waiting for existing '${u}' request completion.`,c),e.serviceRequestId}}},N=(e,t)=>{var n,i,r;const s=t.request.queryParameters,o=null!==(n=s["filter-expr"])&&void 0!==n?n:"",c=null!==(i=s.auth)&&void 0!==i?i:"",u=s.uuid;return(null!==(r=g[t.subscriptionKey])&&void 0!==r?r:[]).filter((t=>t.userId===u&&t.authKey===c&&t.subscription&&(0!==t.subscription.channels.length||0!==t.subscription.channelGroups.length)&&t.subscription.filterExpression===o&&("0"===e||"0"===t.subscription.timetoken||t.subscription.timetoken===e)))},M=e=>{var t,n;const i=e.request.queryParameters,r=null!==(t=i.auth)&&void 0!==t?t:"",s=i.uuid;return(null!==(n=g[e.subscriptionKey])&&void 0!==n?n:[]).filter((e=>e.userId===s&&e.authKey===r))},V=e=>{const t=e.path.split("/")[e.path.startsWith("/v2/subscribe/")?4:6];return","===t?[]:t.split(",").filter((e=>e.length>0))},J=e=>{var t;const n=null!==(t=e.queryParameters["channel-group"])&&void 0!==t?t:"";return 0===n.length?[]:n.split(",").filter((e=>e.length>0))},Q=(e,t)=>{const n=new Set(e);return t.every(n.has,n)},B=()=>{z("Pinging clients...");const e={type:"shared-worker-ping"};Object.values(h).forEach((t=>{let n=!1;t&&t.lastPingRequest&&(z(`Checking whether ${t.clientIdentifier} ping has been sent too long ago...`),(!t.lastPongEvent||Math.abs(t.lastPongEvent-t.lastPingRequest)>5)&&(n=!0,z(`'${t.clientIdentifier}' client is inactive. Invalidating.`),((e,t)=>{delete h[t];let n=g[e];if(n)if(n=n.filter((e=>e.clientIdentifier!==t)),n.length>0?g[e]=n:delete g[e],0===n.length&&delete b[e],n.length>0){const n=v[e];n&&(delete n[t],0===Object.keys(n).length&&delete v[e])}else delete v[e];z(`Invalidate '${t}' client. '${Object.keys(h).length}' clients currently active.`)})(t.subscriptionKey,t.clientIdentifier))),t&&!n&&(z(`Sending ping to ${t.clientIdentifier}...`),t.lastPingRequest=(new Date).getTime()/1e3,T(t,e))})),0===Object.keys(h).length&&a&&clearInterval(a)},z=(e,t)=>{if(!d)return;const n=t?[t]:Object.values(h),i={type:"shared-worker-console-log",message:e};n.forEach((e=>{e&&T(e,i)}))},H=(e,t,n)=>{if(!d)return;const i=n?[n]:Object.values(h),r={type:"shared-worker-console-dir",message:t,data:e};i.forEach((e=>{e&&T(e,r)}))},_=e=>Object.keys(e).map((t=>{const n=e[t];return Array.isArray(n)?n.map((e=>`${t}=${X(e)}`)).join("&"):`${t}=${X(n)}`})).join("&"),X=e=>encodeURIComponent(e).replace(/[!~*'()]/g,(e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`))}));
