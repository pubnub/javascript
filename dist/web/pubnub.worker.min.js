!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function c(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,c)}l((i=i.apply(e,t||[])).next())}))}var t;"function"==typeof SuppressedError&&SuppressedError,function(e){e.GET="GET",e.POST="POST",e.PATCH="PATCH",e.DELETE="DELETE",e.LOCAL="LOCAL"}(t||(t={}));"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var i,r,s={exports:{}};
/*! lil-uuid - v0.1 - MIT License - https://github.com/lil-js/uuid */i=s,function(e){var t="0.1.0",n={3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,all:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i};function i(){var e,t,n="";for(e=0;e<32;e++)t=16*Math.random()|0,8!==e&&12!==e&&16!==e&&20!==e||(n+="-"),n+=(12===e?4:16===e?3&t|8:t).toString(16);return n}function r(e,t){var i=n[t||"all"];return i&&i.test(e)||!1}i.isUUID=r,i.VERSION=t,e.uuid=i,e.isUUID=r}(r=s.exports),null!==i&&(i.exports=r.uuid);var o=n(s.exports),c={createUUID:()=>o.uuid?o.uuid():o()};const l=new Map,u=new TextDecoder,a={},d=c.createUUID(),f=new Map,h={},p={},b={},g={},y={},v={};self.onconnect=e=>{oe("New PubNub Client connected to the Subscription Shared Worker."),e.ports.forEach((e=>{e.start(),e.onmessage=t=>{if(!Q(t))return;const n=t.data;if("client-register"===n.type)n.port=e,F(n),oe(`Client '${n.clientIdentifier}' registered with '${d}' shared worker`);else if("client-unregister"===n.type)U(n);else if("client-pong"===n.type)_(n);else if("send-request"===n.type)if(n.request.path.startsWith("/v2/subscribe")){V(n);const e=h[n.clientIdentifier];if(e){const t=se(e);let i=[];if(l.has(t)&&(i=l.get(t)[0]),i.push([e,n]),!l.has(t)){const e=setTimeout((()=>{I(i,n),l.delete(t)}),50);l.set(t,[i,e])}}}else n.request.path.endsWith("/heartbeat")?(N(n),$(n)):w(n);else"cancel-request"===n.type&&O(n)},e.postMessage({type:"shared-worker-connected"})}))};const I=(e,t)=>{const n=G(t),i=h[t.clientIdentifier];i&&(e=e.filter((e=>e[0].clientIdentifier!==i.clientIdentifier)),q(i,t,n,!0),e.forEach((([e,t])=>q(e,t,n,!1))))},q=(e,t,n,i)=>{var r;let s=!1;if(i||"string"==typeof n||(n=n.identifier),e.subscription&&(s="0"===e.subscription.timetoken),x("start",[e],(new Date).toISOString(),t.request),"string"==typeof n){const i=v[n];if(e){if(e.subscription&&(e.subscription.timetoken=i.timetoken,e.subscription.region=i.region,e.subscription.serviceRequestId=n),!s)return;const o=(new TextEncoder).encode(`{"t":{"t":"${i.timetoken}","r":${null!==(r=i.region)&&void 0!==r?r:"0"}},"m":[]}`),c=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${o.length}`}),l=new Response(o,{status:200,headers:c}),u=L([l,o]);u.url=`${t.request.origin}${t.request.path}`,u.clientIdentifier=t.clientIdentifier,u.identifier=t.request.identifier,x("end",[e],(new Date).toISOString(),t.request,o,c.get("Content-Type"),0),A(e,u)}return}t.request.cancellable&&f.set(n.identifier,new AbortController);const o=v[n.identifier],{timetokenOverride:c,regionOverride:l}=o;j(n,(()=>P(n.identifier)),((e,i)=>{W(e,i,t.request),E(e,n.identifier)}),((e,i)=>{W(e,null,t.request,D(i)),E(e,n.identifier)}),(e=>{let t=e;return s&&c&&"0"!==c&&(t=m(t,c,l)),t})),oe(`'${Object.keys(v).length}' subscription request currently active.`)},m=(e,t,n)=>{if(void 0===t||"0"===t||e[0].status>=400)return e;let i;const r=e[0];let s=r,o=e[1];try{i=JSON.parse((new TextDecoder).decode(o))}catch(t){return oe(`Subscribe response parse error: ${t}`),e}i.t.t=t,n&&(i.t.r=parseInt(n,10));try{if(o=(new TextEncoder).encode(JSON.stringify(i)).buffer,o.byteLength){const e=new Headers(r.headers);e.set("Content-Length",`${o.byteLength}`),s=new Response(o,{status:r.status,statusText:r.statusText,headers:e})}}catch(t){return oe(`Subscribe serialization error: ${t}`),e}return o.byteLength>0?[s,o]:e},$=e=>{var t;const n=h[e.clientIdentifier],i=C(e);if(!n)return;const r=`${n.userId}_${null!==(t=ie(n))&&void 0!==t?t:""}`,s=b[n.subscriptionKey],o=(null!=s?s:{})[r];if(x("start",[n],(new Date).toISOString(),e.request),!i){let t,i;if(oe(`Previous heartbeat request has been sent less than ${n.heartbeatInterval} seconds ago. Skipping...`,n),o&&o.response&&([t,i]=o.response),!t){i=(new TextEncoder).encode('{ "status": 200, "message": "OK", "service": "Presence" }').buffer;const e=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${i.byteLength}`});t=new Response(i,{status:200,headers:e})}const r=L([t,i]);return r.url=`${e.request.origin}${e.request.path}`,r.clientIdentifier=e.clientIdentifier,r.identifier=e.request.identifier,x("end",[n],(new Date).toISOString(),e.request,i,t.headers.get("Content-Type"),0),void A(n,r)}j(i,(()=>[n]),((t,n)=>{o&&(o.response=n),W(t,n,e.request)}),((t,n)=>{W(t,null,e.request,D(n))})),oe("Started heartbeat request.",n)},w=(e,t)=>{var n,i,r;t=null!=t?t:h[e.clientIdentifier];const s=R(e);if(!t)return;const{subscription:o,heartbeat:c}=t,l=null==o?void 0:o.serviceRequestId;if(o&&0===o.channels.length&&0===o.channelGroups.length&&(o.channelGroupQuery="",o.path="",o.previousTimetoken="0",o.timetoken="0",delete o.region,delete o.serviceRequestId,delete o.request),b[t.subscriptionKey]&&c&&0===c.channels.length&&0===c.channelGroups.length){const e=null!==(n=b[r=t.subscriptionKey])&&void 0!==n?n:b[r]={},s=`${t.userId}_${null!==(i=ie(t))&&void 0!==i?i:""}`;e[s]&&e[s].clientIdentifier===t.clientIdentifier&&delete e[s].clientIdentifier}if(!s){const n=(new TextEncoder).encode('{"status": 200, "action": "leave", "message": "OK", "service":"Presence"}'),i=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${n.length}`}),r=new Response(n,{status:200,headers:i}),s=L([r,n]);return s.url=`${e.request.origin}${e.request.path}`,s.clientIdentifier=e.clientIdentifier,s.identifier=e.request.identifier,void A(t,s)}if(j(s,(()=>[t]),((t,n)=>{W(t,n,e.request)}),((t,n)=>{W(t,null,e.request,D(n))})),oe("Started leave request.",t),void 0===l)return;const u=P(l);u.forEach((e=>{e&&e.subscription&&delete e.subscription.serviceRequestId})),S(l),k(u)},O=e=>{const t=h[e.clientIdentifier];if(!t||!t.subscription)return;const n=t.subscription.serviceRequestId;t&&n&&(delete t.subscription.serviceRequestId,t.subscription.request&&t.subscription.request.identifier===e.identifier&&delete t.subscription.request,S(n))},k=e=>{let t,n;for(const i of e)if(i.subscription&&i.subscription.request){n=i.subscription.request,t=i;break}if(!n||!t)return;const i={type:"send-request",clientIdentifier:t.clientIdentifier,subscriptionKey:t.subscriptionKey,logVerbosity:t.logVerbosity,request:n};I([[t,i]],i)},j=(t,n,i,r,s)=>{e(void 0,void 0,void 0,(function*(){var e;const o=(new Date).getTime();Promise.race([fetch(K(t),{signal:null===(e=f.get(t.identifier))||void 0===e?void 0:e.signal,keepalive:!0}),T(t.identifier,t.timeout)]).then((e=>e.arrayBuffer().then((t=>[e,t])))).then((e=>s?s(e):e)).then((e=>{const r=e[1].byteLength>0?e[1]:void 0,s=n();0!==s.length&&(x("end",s,(new Date).toISOString(),t,r,e[0].headers.get("Content-Type"),(new Date).getTime()-o),i(s,e))})).catch((e=>{const t=n();if(0===t.length)return;let i=e;if("string"==typeof e){const t=e.toLowerCase();i=new Error(e),!t.includes("timeout")&&t.includes("cancel")&&(i.name="AbortError")}r(t,i)}))}))},S=e=>{if(0===P(e).length){const t=f.get(e);f.delete(e),delete v[e],t&&t.abort("Cancel request")}},T=(e,t)=>new Promise(((n,i)=>{const r=setTimeout((()=>{f.delete(e),clearTimeout(r),i(new Error("Request timeout"))}),1e3*t)})),P=e=>Object.values(h).filter((t=>void 0!==t&&void 0!==t.subscription&&t.subscription.serviceRequestId===e)),E=(e,t)=>{delete v[t],e.forEach((e=>{e.subscription&&(delete e.subscription.request,delete e.subscription.serviceRequestId)}))},K=e=>{let t;const n=e.queryParameters;let i=e.path;if(e.headers){t={};for(const[n,i]of Object.entries(e.headers))t[n]=i}return n&&0!==Object.keys(n).length&&(i=`${i}?${le(n)}`),new Request(`${e.origin}${i}`,{method:e.method,headers:t,redirect:"follow"})},G=e=>{var t,n,i,r,s;const o=h[e.clientIdentifier],l=o.subscription,u=z(l.timetoken,e),a=c.createUUID(),d=Object.assign({},e.request);let f,p;if(u.length>1){const s=B(u,e);if(s){const e=v[s],{channels:n,channelGroups:i}=null!==(t=o.subscription)&&void 0!==t?t:{channels:[],channelGroups:[]};if((!(n.length>0)||te(e.channels,n))&&(!(i.length>0)||te(e.channelGroups,i)))return s}const c=(null!==(n=g[o.subscriptionKey])&&void 0!==n?n:{})[o.userId],h={},b=new Set(l.channelGroups),y=new Set(l.channels);c&&l.objectsWithState.length&&l.objectsWithState.forEach((e=>{const t=c[e];t&&(h[e]=t)}));for(const e of u){const{subscription:t}=e;if(!t)continue;1!==u.length&&e.clientIdentifier===o.clientIdentifier||!t.timetoken||(f=t.timetoken,p=t.region),t.channelGroups.forEach(b.add,b),t.channels.forEach(y.add,y);const n=t.serviceRequestId;t.serviceRequestId=a,n&&v[n]&&S(n),c&&t.objectsWithState.forEach((e=>{const t=c[e];t&&!h[e]&&(h[e]=t)}))}const I=null!==(i=v[a])&&void 0!==i?i:v[a]={requestId:a,timetoken:null!==(r=d.queryParameters.tt)&&void 0!==r?r:"0",channelGroups:[],channels:[]};if(y.size){I.channels=Array.from(y).sort();const e=d.path.split("/");e[4]=I.channels.join(","),d.path=e.join("/")}if(b.size&&(I.channelGroups=Array.from(b).sort(),d.queryParameters["channel-group"]=I.channelGroups.join(",")),Object.keys(h).length&&(d.queryParameters.state=JSON.stringify(h)),d.queryParameters&&d.queryParameters.auth){const e=re(u);e&&(d.queryParameters.auth=e)}}else v[a]={requestId:a,timetoken:null!==(s=d.queryParameters.tt)&&void 0!==s?s:"0",channelGroups:l.channelGroups,channels:l.channels};v[a]&&(d.queryParameters&&void 0!==d.queryParameters.tt&&void 0!==d.queryParameters.tr&&(v[a].region=d.queryParameters.tr),v[a].timetokenOverride=f,v[a].regionOverride=p),l.serviceRequestId=a,d.identifier=a;const b=u.reduce(((e,{clientIdentifier:t})=>(e.push(t),e)),[]).join(", ");if(b.length>0)for(const e of u)ce(v[a],`Started aggregated request for clients: ${b}`,e);return d},C=e=>{var t,n,i,r,s;const o=h[e.clientIdentifier],c=X(e),l=Object.assign({},e.request);if(!o||!o.heartbeat)return;const u=null!==(t=b[s=o.subscriptionKey])&&void 0!==t?t:b[s]={},a=`${o.userId}_${null!==(n=ie(o))&&void 0!==n?n:""}`,d=[...o.heartbeat.channelGroups],f=[...o.heartbeat.channels];let p,g,y=!1;if(u[a]){const{channels:e,channelGroups:t,response:n}=u[a];p=null!==(r=o.heartbeat.presenceState)&&void 0!==r?r:{},g=te(e,f)&&te(t,d),n&&(y=n[0].status>=400)}else u[a]={channels:f,channelGroups:d,clientIdentifier:o.clientIdentifier,timestamp:Date.now()},p=null!==(i=o.heartbeat.presenceState)&&void 0!==i?i:{},g=!1;let v=o.heartbeatInterval;for(const e of c)e.heartbeatInterval&&(v=Math.min(v,e.heartbeatInterval));if(g&&u[a].clientIdentifier){const e=u[a].timestamp+1e3*v,t=Date.now();if(!y&&t<e&&e-t>5e3)return}delete u[a].response,u[a].clientIdentifier=o.clientIdentifier;for(const t of c){const{heartbeat:n}=t;void 0!==n&&t.clientIdentifier!==e.clientIdentifier&&(n.presenceState&&(p=Object.assign(Object.assign({},p),n.presenceState)),d.push(...n.channelGroups.filter((e=>!d.includes(e)))),f.push(...n.channels.filter((e=>!f.includes(e)))))}u[a].channels=f,u[a].channelGroups=d,u[a].timestamp=Date.now();for(const e in Object.keys(p))f.includes(e)||d.includes(e)||delete p[e];if(0!==f.length||0!==d.length){if(f.length||d.length){const e=l.path.split("/");e[6]=f.length?f.join(","):",",l.path=e.join("/")}if(d.length&&(l.queryParameters["channel-group"]=d.join(",")),Object.keys(p).length?l.queryParameters.state=JSON.stringify(p):delete l.queryParameters.state,c.length>1&&l.queryParameters&&l.queryParameters.auth){const e=re(c);e&&(l.queryParameters.auth=e)}return l}},R=e=>{var t;const n=h[e.clientIdentifier],i=Y(e);let r=ee(e.request),s=Z(e.request);const o=Object.assign({},e.request);if(n&&n.subscription){const{subscription:e}=n;s.length&&(e.channels=e.channels.filter((e=>!s.includes(e)))),r.length&&(e.channelGroups=e.channelGroups.filter((e=>!r.includes(e))))}if(n&&n.heartbeat){const{heartbeat:e}=n;s.length&&(e.channels=e.channels.filter((e=>!s.includes(e)))),r.length&&(e.channelGroups=e.channelGroups.filter((e=>!r.includes(e))))}for(const t of i){const n=t.subscription;void 0!==n&&(t.clientIdentifier!==e.clientIdentifier&&(s.length&&(s=s.filter((e=>!e.endsWith("-pnpres")&&!n.channels.includes(e)))),r.length&&(r=r.filter((e=>!e.endsWith("-pnpres")&&!n.channelGroups.includes(e))))))}if(s.length&&(s=s.filter((e=>!e.endsWith("-pnpres")))),r.length&&(r=r.filter((e=>!e.endsWith("-pnpres")))),0!==s.length||0!==r.length){if(n&&b[n.subscriptionKey]&&(s.length||r.length)){const e=b[n.subscriptionKey],i=`${n.userId}_${null!==(t=ie(n))&&void 0!==t?t:""}`;if(e[i]){let{channels:t,channelGroups:n}=e[i];r.length&&(n=n.filter((e=>!s.includes(e)))),s.length&&(t=t.filter((e=>!s.includes(e)))),e[i].channelGroups=n,e[i].channels=t}}if(s.length){const e=o.path.split("/");e[6]=s.join(","),o.path=e.join("/")}if(r.length&&(o.queryParameters["channel-group"]=r.join(",")),i.length>1&&o.queryParameters&&o.queryParameters.auth){const e=re(i);e&&(o.queryParameters.auth=e)}return o}if(n&&n.workerLogVerbosity){const e=i.reduce(((e,{clientIdentifier:t})=>(e.push(t),e)),[]).join(", ");oe(`Specified channels and groups still in use by other clients: ${e}. Ignoring leave request.`,n)}},A=(e,t)=>{var n;const i=(null!==(n=y[e.subscriptionKey])&&void 0!==n?n:{})[e.clientIdentifier];if(!i)return!1;try{return i.postMessage(t),!0}catch(t){e.workerLogVerbosity&&console.error(`[SharedWorker] Unable send message using message port: ${t}`)}return!1},x=(e,t,n,i,r,s,o)=>{var c,l;if(0===t.length)return;const a=null!==(c=y[t[0].subscriptionKey])&&void 0!==c?c:{},d=i&&i.path.startsWith("/v2/subscribe");let f;if("start"===e)f={type:"request-progress-start",clientIdentifier:"",url:"",timestamp:n};else{let e;r&&s&&(-1!==s.indexOf("text/javascript")||-1!==s.indexOf("application/json")||-1!==s.indexOf("text/plain")||-1!==s.indexOf("text/html"))&&(e=u.decode(r)),f={type:"request-progress-end",clientIdentifier:"",url:"",response:e,timestamp:n,duration:o}}for(const e of t){if(d&&!e.subscription)continue;const t=a[e.clientIdentifier],{request:n}=null!==(l=e.subscription)&&void 0!==l?l:{};let r=null!=n?n:i;if(d||(r=i),e.logVerbosity&&t&&r){const t=Object.assign(Object.assign({},f),{clientIdentifier:e.clientIdentifier,url:`${r.origin}${r.path}`,query:r.queryParameters});A(e,t)}}},W=(e,t,n,i)=>{var r,s;if(0===e.length)return;if(!i&&!t)return;const o=e.some((e=>e&&e.workerLogVerbosity)),c=null!==(r=y[e[0].subscriptionKey])&&void 0!==r?r:{},l=n&&n.path.startsWith("/v2/subscribe");if(!i&&t&&(i=t[0].status>=400?D(void 0,t):L(t)),o&&n&&!n.path.endsWith("/heartbeat")){const t=`Notify clients about ${l?"subscribe":"leave"} request completion: ${e.reduce(((e,{clientIdentifier:t})=>(e.push(t),e)),[]).join(", ")}`;for(const n of e)oe(t,n)}for(const t of e){if(l&&!t.subscription){if(o){const n=`${t.clientIdentifier} doesn't have active subscription. Don't notify about completion.`;for(const t of e)oe(n,t)}continue}const r=c[t.clientIdentifier],{request:u}=null!==(s=t.subscription)&&void 0!==s?s:{};let a=null!=u?u:n;if(l||(a=n),r&&a){const e=Object.assign(Object.assign({},i),{clientIdentifier:t.clientIdentifier,identifier:a.identifier,url:`${a.origin}${a.path}`});A(t,e)}else if(!r&&o){const n=`${t.clientIdentifier} doesn't have Shared Worker's communication channel. Don't notify about completion.`;for(const i of e)i.clientIdentifier!==t.clientIdentifier&&oe(n,i)}}},L=e=>{var t;const[n,i]=e,r=i.byteLength>0?i:void 0,s=parseInt(null!==(t=n.headers.get("Content-Length"))&&void 0!==t?t:"0",10),o=n.headers.get("Content-Type"),c={};return n.headers.forEach(((e,t)=>c[t]=e.toLowerCase())),{type:"request-process-success",clientIdentifier:"",identifier:"",url:"",response:{contentLength:s,contentType:o,headers:c,status:n.status,body:r}}},D=(e,t)=>{if(t)return Object.assign(Object.assign({},L(t)),{type:"request-process-error"});let n="NETWORK_ISSUE",i="Unknown error",r="Error";e&&e instanceof Error&&(i=e.message,r=e.name);const s=i.toLowerCase();return s.includes("timeout")?n="TIMEOUT":("AbortError"===r||s.includes("aborted")||s.includes("cancel"))&&(i="Request aborted",n="ABORTED"),{type:"request-process-error",clientIdentifier:"",identifier:"",url:"",error:{name:r,type:n,message:i}}},F=e=>{var t,n,i,r,s;const{clientIdentifier:o}=e;if(h[o])return;const c=h[o]={clientIdentifier:o,subscriptionKey:e.subscriptionKey,userId:e.userId,heartbeatInterval:e.heartbeatInterval,newlyRegistered:!0,logVerbosity:e.logVerbosity,offlineClientsCheckInterval:e.workerOfflineClientsCheckInterval,unsubscribeOfflineClients:e.workerUnsubscribeOfflineClients,workerLogVerbosity:e.workerLogVerbosity},l=null!==(t=p[r=e.subscriptionKey])&&void 0!==t?t:p[r]=[];l.every((e=>e.clientIdentifier!==o))&&l.push(c),(null!==(n=y[s=e.subscriptionKey])&&void 0!==n?n:y[s]={})[o]=e.port;const u=`Registered PubNub client with '${o}' identifier. '${l.length}' clients currently active.`;for(const e of l)oe(u,e);if(!a[e.subscriptionKey]&&(null!==(i=p[e.subscriptionKey])&&void 0!==i?i:[]).length>0){const{subscriptionKey:t}=e,n=e.workerOfflineClientsCheckInterval;for(const e of l)oe(`Setup PubNub client ping event ${n} seconds`,e);a[t]=setTimeout((()=>ne(t)),500*n-1)}},U=e=>{J(e.subscriptionKey,e.clientIdentifier)},V=e=>{var t,n,i,r,s,o,c,l,u,a,d,f,p,b,y,v,I,q,m,$;const w=e.request.queryParameters,{clientIdentifier:O}=e,k=h[O];if(!k)return;const j=null!==(t=w["channel-group"])&&void 0!==t?t:"",S=null!==(n=w.state)&&void 0!==n?n:"";let T=k.subscription;if(T){if(S.length>0){const e=JSON.parse(S),t=null!==(o=(v=null!==(s=g[y=k.subscriptionKey])&&void 0!==s?s:g[y]={})[I=k.userId])&&void 0!==o?o:v[I]={};Object.entries(e).forEach((([e,n])=>t[e]=n));for(const n of T.objectsWithState)e[n]||delete t[n];T.objectsWithState=Object.keys(e)}else if(T.objectsWithState.length){const e=null!==(l=(m=null!==(c=g[q=k.subscriptionKey])&&void 0!==c?c:g[q]={})[$=k.userId])&&void 0!==l?l:m[$]={};for(const t of T.objectsWithState)delete e[t];T.objectsWithState=[]}}else{if(T={path:"",channelGroupQuery:"",channels:[],channelGroups:[],previousTimetoken:"0",timetoken:"0",objectsWithState:[]},S.length>0){const e=JSON.parse(S),t=null!==(r=(p=null!==(i=g[f=k.subscriptionKey])&&void 0!==i?i:g[f]={})[b=k.userId])&&void 0!==r?r:p[b]={};Object.entries(e).forEach((([e,n])=>t[e]=n)),T.objectsWithState=Object.keys(e)}k.subscription=T}T.path!==e.request.path&&(T.path=e.request.path,T.channels=Z(e.request)),T.channelGroupQuery!==j&&(T.channelGroupQuery=j,T.channelGroups=ee(e.request));let{authKey:P}=k;const{userId:E}=k;T.request=e.request,T.filterExpression=null!==(u=w["filter-expr"])&&void 0!==u?u:"",T.timetoken=null!==(a=w.tt)&&void 0!==a?a:"0",void 0!==w.tr&&(T.region=w.tr),k.authKey=null!==(d=w.auth)&&void 0!==d?d:"",k.origin=e.request.origin,k.userId=w.uuid,k.pnsdk=w.pnsdk,k.accessToken=e.token,k.newlyRegistered&&!P&&k.authKey&&(P=k.authKey),k.newlyRegistered=!1,M(k,E,P)},N=e=>{var t,n;const i=h[e.clientIdentifier],{request:r}=e;if(!i)return;const s=null!==(t=i.heartbeat)&&void 0!==t?t:i.heartbeat={channels:[],channelGroups:[]};s.channelGroups=ee(r).filter((e=>!e.endsWith("-pnpres"))),s.channels=Z(r).filter((e=>!e.endsWith("-pnpres")));const o=null!==(n=r.queryParameters.state)&&void 0!==n?n:"";if(o.length>0){const e=JSON.parse(o);for(const t of Object.keys(e))s.channels.includes(t)||s.channelGroups.includes(t)||delete e[t];s.presenceState=e}},M=(e,t,n)=>{var i,r,s;if(!e||t===e.userId&&(null!=n?n:"")===(null!==(i=e.authKey)&&void 0!==i?i:""))return;const o=null!==(r=b[e.subscriptionKey])&&void 0!==r?r:{},c=`${t}_${null!==(s=ie(e))&&void 0!==s?s:""}`;void 0!==o[c]&&delete o[c]},_=e=>{const t=h[e.clientIdentifier];t&&(t.lastPongEvent=(new Date).getTime()/1e3)},J=(e,t)=>{var n,i,r;const s=h[t];delete h[t];let o=p[e];if(s){if(s.subscription){const{serviceRequestId:e}=s.subscription;delete s.subscription.serviceRequestId,e&&S(e)}if(b[e]){const t=null!==(n=b[e])&&void 0!==n?n:b[e]={},r=`${s.userId}_${null!==(i=ie(s))&&void 0!==i?i:""}`;t[r]&&t[r].clientIdentifier===s.clientIdentifier&&delete t[r].clientIdentifier}s.unsubscribeOfflineClients&&H(s)}if(o)if(o=o.filter((e=>e.clientIdentifier!==t)),o.length>0?p[e]=o:(delete p[e],delete b[e]),0===o.length&&delete g[e],o.length>0){const n=y[e];n&&(delete n[t],0===Object.keys(n).length&&delete y[e])}else delete y[e];const c=`Invalidate '${t}' client. '${(null!==(r=p[e])&&void 0!==r?r:[]).length}' clients currently active.`;if(o)for(const e of o)oe(c,e);else oe(c)},H=e=>{if(!e.subscription)return;const{channels:n,channelGroups:i,serviceRequestId:r}=e.subscription,s=(null!=i?i:[]).filter((e=>!e.endsWith("-pnpres"))).map((e=>ue(e))).sort(),o=(null!=n?n:[]).filter((e=>!e.endsWith("-pnpres"))).map((e=>ue(e))).sort();if(0===o.length&&0===s.length)return;const l=s.length>0?s.join(","):void 0,u=0===o.length?",":o.join(","),a=Object.assign(Object.assign({instanceid:e.clientIdentifier,uuid:e.userId,requestid:c.createUUID()},e.authKey?{auth:e.authKey}:{}),l?{"channel-group":l}:{}),d={type:"send-request",clientIdentifier:e.clientIdentifier,subscriptionKey:e.subscriptionKey,logVerbosity:e.logVerbosity,request:{origin:e.origin,path:`/v2/presence/sub-key/${e.subscriptionKey}/channel/${u}/leave`,queryParameters:a,method:t.GET,headers:{},timeout:10,cancellable:!1,identifier:a.requestid}};w(d,e)},Q=e=>{const{clientIdentifier:t,subscriptionKey:n,logVerbosity:i}=e.data;return void 0!==i&&"boolean"==typeof i&&(!(!t||"string"!=typeof t)&&!(!n||"string"!=typeof n))},B=(e,t)=>{var n;const i=null!==(n=t.request.queryParameters["channel-group"])&&void 0!==n?n:"",r=t.request.path;let s,o;for(const n of e){const{subscription:e}=n;if(!e||!e.serviceRequestId)continue;const c=h[t.clientIdentifier],l=e.serviceRequestId;if(e.path===r&&e.channelGroupQuery===i)return oe(`Found identical request started by '${n.clientIdentifier}' client. \nWaiting for existing '${l}' request completion.`,c),e.serviceRequestId;{const i=v[e.serviceRequestId];if(s||(s=ee(t.request)),o||(o=Z(t.request)),o.length&&!te(i.channels,o))continue;if(s.length&&!te(i.channelGroups,s))continue;return ce(i,`'${t.request.identifier}' request channels and groups are subset of ongoing '${l}' request \nwhich has started by '${n.clientIdentifier}' client. Waiting for existing '${l}' request completion.`,c),e.serviceRequestId}}},z=(e,t)=>{var n,i;const r=h[t.clientIdentifier];if(!r)return[];const s=t.request.queryParameters,o=ie(r),c=null!==(n=s["filter-expr"])&&void 0!==n?n:"",l=s.uuid;return(null!==(i=p[t.subscriptionKey])&&void 0!==i?i:[]).filter((t=>t.userId===l&&ie(t)===o&&t.subscription&&(0!==t.subscription.channels.length||0!==t.subscription.channelGroups.length)&&t.subscription.filterExpression===c&&("0"===e||"0"===t.subscription.timetoken||t.subscription.timetoken===e)))},X=e=>Y(e),Y=e=>{var t;const n=h[e.clientIdentifier];if(!n)return[];const i=e.request.queryParameters,r=ie(n),s=i.uuid;return(null!==(t=p[e.subscriptionKey])&&void 0!==t?t:[]).filter((e=>e.userId===s&&ie(e)===r))},Z=e=>{const t=e.path.split("/")[e.path.startsWith("/v2/subscribe/")?4:6];return","===t?[]:t.split(",").filter((e=>e.length>0))},ee=e=>{var t;const n=null!==(t=e.queryParameters["channel-group"])&&void 0!==t?t:"";return 0===n.length?[]:n.split(",").filter((e=>e.length>0))},te=(e,t)=>{const n=new Set(e);return t.every(n.has,n)},ne=e=>{const t={type:"shared-worker-ping"},n=Object.values(h).filter((t=>t&&t.subscriptionKey===e));if(n.forEach((e=>{let i=!1;if(e&&e.lastPingRequest){const t=e.offlineClientsCheckInterval;if(!e.lastPongEvent||Math.abs(e.lastPongEvent-e.lastPingRequest)>.5*t){i=!0;for(const t of n)oe(`'${e.clientIdentifier}' client is inactive. Invalidating...`,t);J(e.subscriptionKey,e.clientIdentifier)}}e&&!i&&(e.lastPingRequest=(new Date).getTime()/1e3,A(e,t))})),n&&n.length>0&&n[0]){const t=n[0].offlineClientsCheckInterval;a[e]=setTimeout((()=>ne(e)),500*t-1)}},ie=e=>{var t;return e.accessToken&&null!==(t=e.accessToken.token)&&void 0!==t?t:e.authKey},re=e=>{const t=e.filter((e=>!!e.accessToken)).sort(((e,t)=>e.accessToken.expiration-t.accessToken.expiration)).pop();return t?t.authKey:void 0},se=e=>{const t=ie(e);let n=`${e.userId}-${e.subscriptionKey}${t?`-${t}`:""}`;return e.subscription&&e.subscription.filterExpression&&(n+=`-${e.subscription.filterExpression}`),n},oe=(e,t)=>{const n=(t?[t]:Object.values(h)).filter((e=>e&&e.workerLogVerbosity)),i={type:"shared-worker-console-log",message:e};n.forEach((e=>{e&&A(e,i)}))},ce=(e,t,n)=>{const i=(n?[n]:Object.values(h)).filter((e=>e&&e.workerLogVerbosity)),r={type:"shared-worker-console-dir",message:t,data:e};i.forEach((e=>{e&&A(e,r)}))},le=e=>Object.keys(e).map((t=>{const n=e[t];return Array.isArray(n)?n.map((e=>`${t}=${ue(e)}`)).join("&"):`${t}=${ue(n)}`})).join("&"),ue=e=>encodeURIComponent(e).replace(/[!~*'()]/g,(e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`))}));
