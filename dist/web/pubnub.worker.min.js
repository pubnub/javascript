!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function c(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,c)}l((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n,r,i={exports:{}};
/*! lil-uuid - v0.1 - MIT License - https://github.com/lil-js/uuid */n=i,function(e){var t="0.1.0",n={3:/^[0-9A-F]{8}-[0-9A-F]{4}-3[0-9A-F]{3}-[0-9A-F]{4}-[0-9A-F]{12}$/i,4:/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,5:/^[0-9A-F]{8}-[0-9A-F]{4}-5[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i,all:/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i};function r(){var e,t,n="";for(e=0;e<32;e++)t=16*Math.random()|0,8!==e&&12!==e&&16!==e&&20!==e||(n+="-"),n+=(12===e?4:16===e?3&t|8:t).toString(16);return n}function i(e,t){var r=n[t||"all"];return r&&r.test(e)||!1}r.isUUID=i,r.VERSION=t,e.uuid=r,e.isUUID=i}(r=i.exports),null!==n&&(n.exports=r.uuid);var s=t(i.exports),o={createUUID:()=>s.uuid?s.uuid():s()};const c=1e4,l=new Map,u=new TextDecoder;let a,d=!1;const h=o.createUUID(),p=new Map,f={},b={},g={},v={},y={},q={};self.onconnect=e=>{ee("New PubNub Client connected to the Subscription Shared Worker."),e.ports.forEach((e=>{e.start(),e.onmessage=t=>{if(!J(t))return;const n=t.data;if("client-register"===n.type)!d&&n.workerLogVerbosity&&(d=!0),n.port=e,U(n),ee(`Client '${n.clientIdentifier}' registered with '${h}' shared worker`);else if("client-pong"===n.type)V(n);else if("send-request"===n.type)if(n.request.path.startsWith("/v2/subscribe")){L(n);const e=f[n.clientIdentifier];if(e){const t=`${e.userId}-${e.subscriptionKey}`;if(!l.has(t)){const e=setTimeout((()=>{I(n),l.delete(t)}),50);l.set(t,e)}}}else n.request.path.endsWith("/heartbeat")?(N(n),w(n)):j(n);else"cancel-request"===n.type&&O(n)},e.postMessage({type:"shared-worker-connected"})}))};const I=e=>{var t;const n=A(e),r=f[e.clientIdentifier];let i=!1;if(r&&(r.subscription&&(i="0"===r.subscription.timetoken),C("start",[r],(new Date).toISOString(),e.request)),"string"==typeof n){const s=q[n];if(r){if(r.subscription&&(r.subscription.timetoken=s.timetoken,r.subscription.region=s.region,r.subscription.serviceRequestId=n),!i)return;const o=(new TextEncoder).encode(`{"t":{"t":"${s.timetoken}","r":${null!==(t=s.region)&&void 0!==t?t:"0"}},"m":[]}`),c=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${o.length}`}),l=new Response(o,{status:200,headers:c}),u=D([l,o]);u.url=`${e.request.origin}${e.request.path}`,u.clientIdentifier=e.clientIdentifier,u.identifier=e.request.identifier,C("end",[r],(new Date).toISOString(),e.request,o,c.get("Content-Type"),0),R(r,u)}return}e.request.cancellable&&p.set(n.identifier,new AbortController);const s=q[n.identifier],{timetokenOverride:o,regionOverride:c}=s;S(n,(()=>E(n.identifier)),((t,r)=>{F(t,r,e.request),G(t,n.identifier)}),((t,r)=>{F(t,null,e.request,W(r)),G(t,n.identifier)}),(e=>{let t=e;return i&&o&&"0"!==o&&(q[n.identifier],t=m(t,o,c)),t})),ee(`'${Object.keys(q).length}' subscription request currently active.`)},m=(e,t,n)=>{if(void 0===t||"0"===t||e[0].status>=400)return e;let r;const i=e[0];let s=i,o=e[1];try{r=JSON.parse((new TextDecoder).decode(o))}catch(t){return ee(`Subscribe response parse error: ${t}`),e}r.t.t=t,n&&(r.t.r=parseInt(n,10));try{if(o=(new TextEncoder).encode(JSON.stringify(r)).buffer,o.byteLength){const e=new Headers(i.headers);e.set("Content-Length",`${o.byteLength}`),s=new Response(o,{status:i.status,statusText:i.statusText,headers:e})}}catch(t){return ee(`Subscribe serialization error: ${t}`),e}return o.byteLength>0?[s,o]:e},w=e=>{var t;const n=f[e.clientIdentifier],r=x(e);if(!n)return;const i=`${n.userId}_${null!==(t=n.authKey)&&void 0!==t?t:""}`,s=g[n.subscriptionKey],o=(null!=s?s:{})[i];if(C("start",[n],(new Date).toISOString(),r),!r){let t,r;if(ee(`Previous heartbeat request has been sent less than ${n.heartbeatInterval} seconds ago. Skipping...`),o&&o.response&&([t,r]=o.response),!t){r=(new TextEncoder).encode('{ "status": 200, "message": "OK", "service": "Presence" }').buffer;const e=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${r.byteLength}`});t=new Response(r,{status:200,headers:e})}const i=D([t,r]);return i.url=`${e.request.origin}${e.request.path}`,i.clientIdentifier=e.clientIdentifier,i.identifier=e.request.identifier,C("end",[n],(new Date).toISOString(),e.request,r,t.headers.get("Content-Type"),0),void R(n,i)}S(r,(()=>[n]),((t,n)=>{o&&(o.response=n),F(t,n,e.request)}),((t,n)=>{F(t,null,e.request,W(n))})),ee("Started heartbeat request.",n)},j=e=>{const t=f[e.clientIdentifier],n=K(e);if(!t)return;const{subscription:r}=t,i=null==r?void 0:r.serviceRequestId;if(r&&0===r.channels.length&&0===r.channelGroups.length&&(r.channelGroupQuery="",r.path="",r.previousTimetoken="0",r.timetoken="0",delete r.region,delete r.serviceRequestId,delete r.request),!n){const n=(new TextEncoder).encode('{"status": 200, "action": "leave", "message": "OK", "service":"Presence"}'),r=new Headers({"Content-Type":'text/javascript; charset="UTF-8"',"Content-Length":`${n.length}`}),i=new Response(n,{status:200,headers:r}),s=D([i,n]);return s.url=`${e.request.origin}${e.request.path}`,s.clientIdentifier=e.clientIdentifier,s.identifier=e.request.identifier,void R(t,s)}if(S(n,(()=>[t]),((t,n)=>{F(t,n,e.request)}),((t,n)=>{F(t,null,e.request,W(n))})),ee("Started leave request.",t),void 0===i)return;const s=E(i);s.forEach((e=>{e&&e.subscription&&delete e.subscription.serviceRequestId})),k(i),$(s)},O=e=>{const t=f[e.clientIdentifier];if(!t||!t.subscription)return;const n=t.subscription.serviceRequestId;t&&n&&(delete t.subscription.serviceRequestId,t.subscription.request&&t.subscription.request.identifier===e.identifier&&delete t.subscription.request,k(n))},$=e=>{let t,n;for(const r of e)if(r.subscription&&r.subscription.request){n=r.subscription.request,t=r;break}n&&t&&I({type:"send-request",clientIdentifier:t.clientIdentifier,subscriptionKey:t.subscriptionKey,logVerbosity:t.logVerbosity,request:n})},S=(t,n,r,i,s)=>{e(void 0,void 0,void 0,(function*(){var e;const o=(new Date).getTime();Promise.race([fetch(T(t),{signal:null===(e=p.get(t.identifier))||void 0===e?void 0:e.signal,keepalive:!0}),P(t.identifier,t.timeout)]).then((e=>e.arrayBuffer().then((t=>[e,t])))).then((e=>s?s(e):e)).then((e=>{const i=e[1].byteLength>0?e[1]:void 0,s=n();0!==s.length&&(C("end",s,(new Date).toISOString(),t,i,e[0].headers.get("Content-Type"),(new Date).getTime()-o),r(s,e))})).catch((e=>{const t=n();if(0===t.length)return;let r=e;if("string"==typeof e){const t=e.toLowerCase();t.includes("timeout")||!t.includes("cancel")?r=new Error(e):t.includes("cancel")&&(r=new DOMException("Aborted","AbortError"))}i(t,r)}))}))},k=e=>{if(0===E(e).length){const t=p.get(e);p.delete(e),delete q[e],t&&t.abort("Cancel request")}},P=(e,t)=>new Promise(((n,r)=>{const i=setTimeout((()=>{p.delete(e),clearTimeout(i),r(new Error("Request timeout"))}),1e3*t)})),E=e=>Object.values(f).filter((t=>void 0!==t&&void 0!==t.subscription&&t.subscription.serviceRequestId===e)),G=(e,t)=>{delete q[t],e.forEach((e=>{e.subscription&&(delete e.subscription.request,delete e.subscription.serviceRequestId)}))},T=e=>{let t;const n=e.queryParameters;let r=e.path;if(e.headers){t={};for(const[n,r]of Object.entries(e.headers))t[n]=r}return n&&0!==Object.keys(n).length&&(r=`${r}?${ne(n)}`),new Request(`${e.origin}${r}`,{method:e.method,headers:t,redirect:"follow"})},A=e=>{var t,n,r,i,s;const c=f[e.clientIdentifier],l=c.subscription,u=Q(l.timetoken,e),a=o.createUUID(),h=Object.assign({},e.request);let p,b;if(u.length>1){const s=_(u,e);if(s){const e=q[s],{channels:n,channelGroups:r}=null!==(t=c.subscription)&&void 0!==t?t:{channels:[],channelGroups:[]};if((!(n.length>0)||Y(e.channels,n))&&(!(r.length>0)||Y(e.channelGroups,r)))return s}const o=(null!==(n=v[c.subscriptionKey])&&void 0!==n?n:{})[c.userId],d={},f=new Set(l.channelGroups),g=new Set(l.channels);o&&l.objectsWithState.length&&l.objectsWithState.forEach((e=>{const t=o[e];t&&(d[e]=t)}));for(const e of u){const{subscription:t}=e;if(!t)continue;1!==u.length&&e.clientIdentifier===c.clientIdentifier||!t.timetoken||(p=t.timetoken,b=t.region),t.channelGroups.forEach(f.add,f),t.channels.forEach(g.add,g);const n=t.serviceRequestId;t.serviceRequestId=a,n&&q[n]&&k(n),o&&t.objectsWithState.forEach((e=>{const t=o[e];t&&!d[e]&&(d[e]=t)}))}const y=null!==(r=q[a])&&void 0!==r?r:q[a]={requestId:a,timetoken:null!==(i=h.queryParameters.tt)&&void 0!==i?i:"0",channelGroups:[],channels:[]};if(g.size){y.channels=Array.from(g).sort();const e=h.path.split("/");e[4]=y.channels.join(","),h.path=e.join("/")}f.size&&(y.channelGroups=Array.from(f).sort(),h.queryParameters["channel-group"]=y.channelGroups.join(",")),Object.keys(d).length&&(h.queryParameters.state=JSON.stringify(d))}else q[a]={requestId:a,timetoken:null!==(s=h.queryParameters.tt)&&void 0!==s?s:"0",channelGroups:l.channelGroups,channels:l.channels};if(q[a]&&(h.queryParameters&&void 0!==h.queryParameters.tt&&void 0!==h.queryParameters.tr&&(q[a].region=h.queryParameters.tr),q[a].timetokenOverride=p,q[a].regionOverride=b),l.serviceRequestId=a,h.identifier=a,d){const e=u.reduce(((e,{clientIdentifier:t})=>(e.push(t),e)),[]).join(",");te(q[a],`Started aggregated request for clients: ${e}`)}return h},x=e=>{var t,n,r,i,s;const o=f[e.clientIdentifier],c=B(e),l=Object.assign({},e.request);if(!o||!o.heartbeat)return;const u=null!==(t=g[s=o.subscriptionKey])&&void 0!==t?t:g[s]={},a=`${o.userId}_${null!==(n=o.authKey)&&void 0!==n?n:""}`,d=o.heartbeat.channelGroups,h=o.heartbeat.channels;let p={},b=!1,v=!0;if(u[a]){const{channels:e,channelGroups:t,response:n}=u[a];p=null!==(i=o.heartbeat.presenceState)&&void 0!==i?i:{},v=Y(e,o.heartbeat.channels)&&Y(t,o.heartbeat.channelGroups),n&&(b=n[0].status>=400)}else u[a]={channels:h,channelGroups:d,timestamp:Date.now()},p=null!==(r=o.heartbeat.presenceState)&&void 0!==r?r:{},v=!1;if(v){const t=u[a].timestamp+1e3*o.heartbeatInterval,n=Date.now();if(!b&&n<t&&t-n>5e3)return;delete u[a].response;for(const t of c){const{heartbeat:n}=t;void 0!==n&&t.clientIdentifier!==e.clientIdentifier&&(n.presenceState&&(p=Object.assign(Object.assign({},p),n.presenceState)),d.push(...n.channelGroups.filter((e=>!d.includes(e)))),h.push(...n.channels.filter((e=>!h.includes(e)))))}}u[a].channels=h,u[a].channelGroups=d,u[a].timestamp=Date.now();for(const e in Object.keys(p))h.includes(e)||d.includes(e)||delete p[e];if(h.length){const e=l.path.split("/");e[6]=h.join(","),l.path=e.join("/")}return d.length&&(l.queryParameters["channel-group"]=d.join(",")),Object.keys(p).length?l.queryParameters.state=JSON.stringify(p):delete l.queryParameters.state,l},K=e=>{const t=f[e.clientIdentifier],n=H(e);let r=X(e.request),i=z(e.request);const s=Object.assign({},e.request);if(t&&t.subscription){const{subscription:e}=t;i.length&&(e.channels=e.channels.filter((e=>!i.includes(e)))),r.length&&(e.channelGroups=e.channelGroups.filter((e=>!r.includes(e))))}if(t&&t.heartbeat){const{heartbeat:e}=t;i.length&&(e.channels=e.channels.filter((e=>!i.includes(e)))),r.length&&(e.channelGroups=e.channelGroups.filter((e=>!r.includes(e))))}for(const t of n){const n=t.subscription;void 0!==n&&(t.clientIdentifier!==e.clientIdentifier&&(i.length&&(i=i.filter((e=>!n.channels.includes(e)))),r.length&&(r=r.filter((e=>!n.channelGroups.includes(e))))))}if(0!==i.length||0!==r.length){if(i.length){const e=s.path.split("/");e[6]=i.join(","),s.path=e.join("/")}return r.length&&(s.queryParameters["channel-group"]=r.join(",")),s}if(d&&t){const e=n.reduce(((e,{clientIdentifier:t})=>(e.push(t),e)),[]).join(",");ee(`Specified channels and groups still in use by other clients: ${e}. Ignoring leave request.`,t)}},R=(e,t)=>{var n;const r=(null!==(n=y[e.subscriptionKey])&&void 0!==n?n:{})[e.clientIdentifier];if(!r)return!1;try{return r.postMessage(t),!0}catch(e){}return!1},C=(e,t,n,r,i,s,o)=>{var c,l;if(0===t.length)return;const a=null!==(c=y[t[0].subscriptionKey])&&void 0!==c?c:{},d=r&&r.path.startsWith("/v2/subscribe");let h;if("start"===e)h={type:"request-progress-start",clientIdentifier:"",url:"",timestamp:n};else{let e;i&&s&&(-1!==s.indexOf("text/javascript")||-1!==s.indexOf("application/json")||-1!==s.indexOf("text/plain")||-1!==s.indexOf("text/html"))&&(e=u.decode(i)),h={type:"request-progress-end",clientIdentifier:"",url:"",response:e,timestamp:n,duration:o}}for(const e of t){if(d&&!e.subscription)continue;const t=a[e.clientIdentifier],{request:n}=null!==(l=e.subscription)&&void 0!==l?l:{};let i=null!=n?n:r;if(d||(i=r),e.logVerbosity&&t&&i){const t=Object.assign(Object.assign({},h),{clientIdentifier:e.clientIdentifier,url:`${i.origin}${i.path}`,query:i.queryParameters});R(e,t)}}},F=(e,t,n,r)=>{var i,s;if(0===e.length)return;if(!r&&!t)return;const o=null!==(i=y[e[0].subscriptionKey])&&void 0!==i?i:{},c=n&&n.path.startsWith("/v2/subscribe");!r&&t&&(r=t[0].status>=400?W(void 0,t):D(t));for(const t of e){if(c&&!t.subscription)continue;const e=o[t.clientIdentifier],{request:i}=null!==(s=t.subscription)&&void 0!==s?s:{};let l=null!=i?i:n;if(c||(l=n),e&&l){const e=Object.assign(Object.assign({},r),{clientIdentifier:t.clientIdentifier,identifier:l.identifier,url:`${l.origin}${l.path}`});R(t,e)}}},D=e=>{var t;const[n,r]=e,i=r.byteLength>0?r:void 0,s=parseInt(null!==(t=n.headers.get("Content-Length"))&&void 0!==t?t:"0",10),o=n.headers.get("Content-Type"),c={};return n.headers.forEach(((e,t)=>c[t]=e.toLowerCase())),{type:"request-process-success",clientIdentifier:"",identifier:"",url:"",response:{contentLength:s,contentType:o,headers:c,status:n.status,body:i}}},W=(e,t)=>{if(t)return Object.assign(Object.assign({},D(t)),{type:"request-process-error"});let n="NETWORK_ISSUE",r="Unknown error",i="Error";return e&&e instanceof Error&&(r=e.message,i=e.name),r.toLowerCase().includes("timeout")?n="TIMEOUT":("AbortError"===i||r.toLowerCase().includes("cancel"))&&(r="Request aborted",n="ABORTED"),{type:"request-process-error",clientIdentifier:"",identifier:"",url:"",error:{name:i,type:n,message:r}}},U=e=>{var t,n,r,i;const{clientIdentifier:s}=e;if(f[s])return;const o=f[s]={clientIdentifier:s,subscriptionKey:e.subscriptionKey,userId:e.userId,heartbeatInterval:e.heartbeatInterval,logVerbosity:e.logVerbosity},l=null!==(t=b[r=e.subscriptionKey])&&void 0!==t?t:b[r]=[];l.every((e=>e.clientIdentifier!==s))&&l.push(o),(null!==(n=y[i=e.subscriptionKey])&&void 0!==n?n:y[i]={})[s]=e.port,ee(`Registered PubNub client with '${s}' identifier. '${Object.keys(f).length}' clients currently active.`),!a&&Object.keys(f).length>0&&(ee("Setup PubNub client ping event 10 seconds"),a=setInterval((()=>Z()),c))},L=e=>{var t,n,r,i,s,o,c,l,u,a,d,h,p,b,g,y,q,I,m,w;const j=e.request.queryParameters,{clientIdentifier:O}=e,$=f[O];if(!$)return;const S=null!==(t=j["channel-group"])&&void 0!==t?t:"",k=null!==(n=j.state)&&void 0!==n?n:"";let P=$.subscription;if(P){if(k.length>0){const e=JSON.parse(k),t=null!==(o=(y=null!==(s=v[g=$.subscriptionKey])&&void 0!==s?s:v[g]={})[q=$.userId])&&void 0!==o?o:y[q]={};Object.entries(e).forEach((([e,n])=>t[e]=n));for(const n of P.objectsWithState)e[n]||delete t[n];P.objectsWithState=Object.keys(e)}else if(P.objectsWithState.length){const e=null!==(l=(m=null!==(c=v[I=$.subscriptionKey])&&void 0!==c?c:v[I]={})[w=$.userId])&&void 0!==l?l:m[w]={};for(const t of P.objectsWithState)delete e[t];P.objectsWithState=[]}}else{if(P={path:"",channelGroupQuery:"",channels:[],channelGroups:[],previousTimetoken:"0",timetoken:"0",objectsWithState:[]},k.length>0){const e=JSON.parse(k),t=null!==(i=(p=null!==(r=v[h=$.subscriptionKey])&&void 0!==r?r:v[h]={})[b=$.userId])&&void 0!==i?i:p[b]={};Object.entries(e).forEach((([e,n])=>t[e]=n)),P.objectsWithState=Object.keys(e)}$.subscription=P}P.path!==e.request.path&&(P.path=e.request.path,P.channels=z(e.request)),P.channelGroupQuery!==S&&(P.channelGroupQuery=S,P.channelGroups=X(e.request));const{authKey:E,userId:G}=$;P.request=e.request,P.filterExpression=null!==(u=j["filter-expr"])&&void 0!==u?u:"",P.timetoken=null!==(a=j.tt)&&void 0!==a?a:"0",void 0!==j.tr&&(P.region=j.tr),$.authKey=null!==(d=j.auth)&&void 0!==d?d:"",$.userId=j.uuid,M($,G,E)},N=e=>{var t,n;const r=f[e.clientIdentifier],{request:i}=e;if(!r)return;const s=null!==(t=r.heartbeat)&&void 0!==t?t:r.heartbeat={channels:[],channelGroups:[]};s.channelGroups=X(i).filter((e=>!e.endsWith("-pnpres"))),s.channels=z(i).filter((e=>!e.endsWith("-pnpres")));const o=null!==(n=i.queryParameters.state)&&void 0!==n?n:"";if(o.length>0){const e=JSON.parse(o);for(const t of Object.keys(e))s.channels.includes(t)||s.channelGroups.includes(t)||delete e[t];s.presenceState=e}},M=(e,t,n)=>{var r,i;if(!e||t===e.userId&&(null!=n?n:"")===(null!==(r=e.authKey)&&void 0!==r?r:""))return;const s=null!==(i=g[e.subscriptionKey])&&void 0!==i?i:{},o=`${t}_${null!=n?n:""}`;void 0!==s[o]&&delete s[o]},V=e=>{const t=f[e.clientIdentifier];t&&(t.lastPongEvent=(new Date).getTime()/1e3)},J=e=>{const{clientIdentifier:t,subscriptionKey:n,logVerbosity:r}=e.data;return void 0!==r&&"boolean"==typeof r&&(!(!t||"string"!=typeof t)&&!(!n||"string"!=typeof n))},_=(e,t)=>{var n;const r=null!==(n=t.request.queryParameters["channel-group"])&&void 0!==n?n:"",i=t.request.path;let s,o;for(const n of e){const{subscription:e}=n;if(!e||!e.serviceRequestId)continue;const c=f[t.clientIdentifier],l=e.serviceRequestId;if(e.path===i&&e.channelGroupQuery===r)return ee(`Found identical request started by '${n.clientIdentifier}' client. \nWaiting for existing '${l}' request completion.`,c),e.serviceRequestId;{const r=q[e.serviceRequestId];if(s||(s=X(t.request)),o||(o=z(t.request)),o.length&&!Y(r.channels,o))continue;if(s.length&&!Y(r.channelGroups,s))continue;return te(r,`'${t.request.identifier}' request channels and groups are subset of ongoing '${l}' request \nwhich has started by '${n.clientIdentifier}' client. Waiting for existing '${l}' request completion.`,c),e.serviceRequestId}}},Q=(e,t)=>{var n,r,i;const s=t.request.queryParameters,o=null!==(n=s["filter-expr"])&&void 0!==n?n:"",c=null!==(r=s.auth)&&void 0!==r?r:"",l=s.uuid;return(null!==(i=b[t.subscriptionKey])&&void 0!==i?i:[]).filter((t=>t.userId===l&&t.authKey===c&&t.subscription&&(0!==t.subscription.channels.length||0!==t.subscription.channelGroups.length)&&t.subscription.filterExpression===o&&("0"===e||"0"===t.subscription.timetoken||t.subscription.timetoken===e)))},B=e=>H(e),H=e=>{var t,n;const r=e.request.queryParameters,i=null!==(t=r.auth)&&void 0!==t?t:"",s=r.uuid;return(null!==(n=b[e.subscriptionKey])&&void 0!==n?n:[]).filter((e=>e.userId===s&&e.authKey===i))},z=e=>{const t=e.path.split("/")[e.path.startsWith("/v2/subscribe/")?4:6];return","===t?[]:t.split(",").filter((e=>e.length>0))},X=e=>{var t;const n=null!==(t=e.queryParameters["channel-group"])&&void 0!==t?t:"";return 0===n.length?[]:n.split(",").filter((e=>e.length>0))},Y=(e,t)=>{const n=new Set(e);return t.every(n.has,n)},Z=()=>{ee("Pinging clients...");const e={type:"shared-worker-ping"};Object.values(f).forEach((t=>{let n=!1;t&&t.lastPingRequest&&(ee(`Checking whether ${t.clientIdentifier} ping has been sent too long ago...`),(!t.lastPongEvent||Math.abs(t.lastPongEvent-t.lastPingRequest)>5)&&(n=!0,ee(`'${t.clientIdentifier}' client is inactive. Invalidating.`),((e,t)=>{delete f[t];let n=b[e];if(n)if(n=n.filter((e=>e.clientIdentifier!==t)),n.length>0?b[e]=n:(delete b[e],delete g[e]),0===n.length&&delete v[e],n.length>0){const n=y[e];n&&(delete n[t],0===Object.keys(n).length&&delete y[e])}else delete y[e];ee(`Invalidate '${t}' client. '${Object.keys(f).length}' clients currently active.`)})(t.subscriptionKey,t.clientIdentifier))),t&&!n&&(ee(`Sending ping to ${t.clientIdentifier}...`),t.lastPingRequest=(new Date).getTime()/1e3,R(t,e))})),0===Object.keys(f).length&&a&&clearInterval(a)},ee=(e,t)=>{if(!d)return;const n=t?[t]:Object.values(f),r={type:"shared-worker-console-log",message:e};n.forEach((e=>{e&&R(e,r)}))},te=(e,t,n)=>{if(!d)return;const r=n?[n]:Object.values(f),i={type:"shared-worker-console-dir",message:t,data:e};r.forEach((e=>{e&&R(e,i)}))},ne=e=>Object.keys(e).map((t=>{const n=e[t];return Array.isArray(n)?n.map((e=>`${t}=${re(e)}`)).join("&"):`${t}=${re(n)}`})).join("&"),re=e=>encodeURIComponent(e).replace(/[!~*'()]/g,(e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`))}));
